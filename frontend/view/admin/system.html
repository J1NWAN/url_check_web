{% extends "common/layout/admin-layout.html" %}

{% block title %}System - URL Checker{% endblock %}

{% block breadcrumb_title %}시스템{% endblock %}

{% block page_styles %}
<style>
  .profile-header {
    background-image: url('/assets/img/bg-smart-home-1.jpg');
    background-position: center;
    background-size: cover;
  }
  
  .hidden-item {
    display: none;
  }
  
  .show-more-btn {
    width: 100%;
    margin-top: 15px;
  }
  
  .system-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
  }
  
  .system-modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 600px;
    border-radius: 8px;
  }
  
  .close-modal {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }
  
  .close-modal:hover,
  .close-modal:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
  }
  
  .form-group {
    margin-bottom: 15px;
  }
  
  /* 입력 필드 테두리 스타일 */
  .form-control {
    border: 1px solid #d2d6da !important;
    padding: 0.5rem 0.75rem !important;
    font-size: 0.875rem;
    line-height: 1.4rem;
    border-radius: 0.375rem;
  }
  
  .form-control:focus {
    border-color: #7928CA !important;
    box-shadow: 0 0 0 2px rgba(121, 40, 202, 0.25);
  }
  
  .menu-item {
    padding: 10px;
    border-radius: 0.375rem;
    background-color: #f8f9fa;
    margin-bottom: 8px !important;
  }
  
  /* 수동 점검 모달 스타일 */
  .manual-modal-content {
    max-width: 600px;
    height: 80%;
    max-height: 60vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  
  .menu-item {
    transition: all 0.2s ease;
    cursor: pointer;
    border-radius: 0.375rem;
  }
  
  .menu-item:hover {
    background-color: #f8f9fa;
  }
  
  .menu-item.active {
    background-color: #f1f1f1;
    border-left: 3px solid #7928CA;
  }
  
  .iframe-container {
    background-color: #f8f9fa;
    border-radius: 0.375rem;
    position: relative;
  }
  
  .iframe-loading {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: rgba(255, 255, 255, 0.8);
    z-index: 10;
  }
  
  .menu-list-container {
    max-height: calc(100% - 70px);
    overflow-y: auto;
  }
  
  .checked-menu {
    background-color: rgba(76, 175, 80, 0.1);
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-md-7 mt-4">
      <div class="card">
        <div class="card-header pb-0 px-3">
          <h6 class="mb-0 d-flex justify-content-between">
            시스템 목록
            <div class="d-flex justify-content-end">
              <a class="btn bg-gradient-dark mb-0 me-2" href="javascript:;" id="add-system-btn"><i class="material-symbols-rounded text-sm">add</i>&nbsp;&nbsp;시스템 추가</a>
              <a class="btn bg-gradient-dark mb-0" href="javascript:;" id="check-system-btn"><i class="material-symbols-rounded text-sm">check</i>&nbsp;&nbsp;전체 점검</a>
            </div>
          </h6>
        </div>
        <div class="card-body pt-4 p-3">
          <ul class="list-group" id="system-list">
            <!-- 시스템 목록이 여기에 동적으로 추가됩니다 -->
          </ul>
          <div id="loading-system" class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">로딩중...</span>
            </div>
          </div>
          <div id="empty-system" class="text-center py-3" style="display: none;">
            <p class="text-muted">등록된 시스템이 없습니다.</p>
          </div>
          <button id="show-more-btn" class="btn bg-gradient-primary show-more-btn" style="display: none;">더보기</button>
        </div>
      </div>
    </div>
    <div class="col-md-5 mt-4">
      <div class="card mb-4">
        <div class="card-header pb-0 px-3">
          <div class="row">
            <div class="col-md-6">
              <h6 class="mb-0">최근 점검 결과</h6>
            </div>
          </div>
        </div>
        <div class="card-body pt-4 p-3">
          <h6 class="text-uppercase text-body text-xs font-weight-bolder mb-3">최근 점검 기록</h6>
          <ul class="list-group" id="recent-inspections">
            <!-- 최근 점검 결과가 여기에 동적으로 추가됩니다 -->
            <div id="loading-inspections" class="text-center py-3">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">로딩중...</span>
              </div>
            </div>
            <div id="empty-inspections" class="text-center py-3" style="display: none;">
              <p class="text-muted">점검 이력이 없습니다.</p>
            </div>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 시스템 추가/수정 모달 -->
<div id="system-modal" class="system-modal">
  <div class="system-modal-content">
    <span class="close-modal">&times;</span>
    <h5 id="system-modal-title">시스템 추가</h5>
    <form id="system-form">
      <input type="hidden" id="system-id" name="system-id">
      <div class="form-group">
        <label for="eng-name">시스템 영문명</label>
        <input type="text" class="form-control" id="eng-name" name="eng-name" required>
      </div>
      <div class="form-group">
        <label for="kor-name">시스템 한글명</label>
        <input type="text" class="form-control" id="kor-name" name="kor-name" required>
      </div>
      <div class="form-group">
        <label for="url">시스템 URL (도메인)</label>
        <input type="url" class="form-control" id="url" name="url" required placeholder="도메인만 입력해주세요 (예: https://example.com)">
        <small class="form-text text-muted">도메인만 입력해주세요. 경로는 메뉴에서 지정합니다.</small>
      </div>
      <div class="form-group">
        <div class="d-flex justify-content-between align-items-center">
          <label class="mb-0">메뉴 목록</label>
          <button type="button" class="btn btn-sm bg-gradient-info mt-2 mb-2" id="add-menu-btn">
            <i class="material-symbols-rounded">add</i> 메뉴 추가
          </button>
        </div>
        <div id="menu-container">
          <!-- 메뉴 항목이 동적으로 추가됩니다 -->
        </div>
      </div>
      <div class="d-flex justify-content-end mt-4">
        <button type="button" class="btn btn-secondary me-2" id="cancel-system-btn">취소</button>
        <button type="submit" class="btn bg-gradient-primary" id="save-system-btn">저장</button>
      </div>
    </form>
  </div>
</div>

<!-- 수동 점검 모달 -->
<div id="manual-inspection-modal" class="system-modal">
  <div class="system-modal-content manual-modal-content">
    <span class="close-modal" id="close-manual-inspection">&times;</span>
    <h5 id="manual-inspection-title">수동 점검</h5>
    <div class="row flex-grow-1" style="overflow: hidden; margin-top: 10px;">
      <div class="col-md-12" style="height: 100%;">
        <div class="card h-100">
          <div class="card-header p-3">
            <h6 class="mb-0">메뉴 목록</h6>
            <p class="text-xs text-muted mb-0">아래 메뉴를 클릭하여 새 탭에서 확인해주세요. 확인 후 메뉴 항목이 녹색으로 변경됩니다.</p>
          </div>
          <div class="card-body p-2 menu-list-container">
            <ul class="list-group" id="manual-menu-list">
              <!-- 메뉴 목록이 여기에 동적으로 추가됩니다 -->
            </ul>
          </div>
          <div class="card-footer p-3">
            <button id="complete-inspection-btn" class="btn bg-gradient-success w-100" disabled>점검 완료</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SweetAlert2 추가 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    //===================================================================
    // 1. 요소 참조
    //===================================================================
    const systemList = document.getElementById('system-list');
    const loadingSystem = document.getElementById('loading-system');
    const emptySystem = document.getElementById('empty-system');
    const showMoreBtn = document.getElementById('show-more-btn');
    const systemModal = document.getElementById('system-modal');
    const systemForm = document.getElementById('system-form');
    const systemModalTitle = document.getElementById('system-modal-title');
    const systemId = document.getElementById('system-id');
    const addSystemBtn = document.getElementById('add-system-btn');
    const cancelSystemBtn = document.getElementById('cancel-system-btn');
    const closeModal = document.querySelector('.close-modal');
    const menuContainer = document.getElementById('menu-container');
    const addMenuBtn = document.getElementById('add-menu-btn');
    const checkSystemBtn = document.getElementById('check-system-btn');
    
    // 수동 점검 관련 요소들
    const manualInspectionModal = document.getElementById('manual-inspection-modal');
    const closeManualInspection = document.getElementById('close-manual-inspection');
    const manualMenuList = document.getElementById('manual-menu-list');
    const completeInspectionBtn = document.getElementById('complete-inspection-btn');
    
    //===================================================================
    // 2. 공통 상수 및 상태
    //===================================================================
    // HTTP 상태 코드에 대한 한글 설명
    const HTTP_STATUS_TEXT = {
      200: "정상",
      201: "생성됨",
      301: "영구 이동",
      302: "임시 이동",
      400: "잘못된 요청",
      401: "인증 실패",
      403: "접근 금지",
      404: "찾을 수 없음",
      408: "요청 시간 초과",
      500: "서버 내부 오류",
      502: "게이트웨이 오류",
      503: "서비스 사용 불가",
      504: "게이트웨이 시간 초과"
    };
    
    // 수동 점검 현재 상태
    let currentInspection = {
      systemId: null,
      systemName: null,
      menus: [],
      checkedMenus: new Set(),
      currentUrl: null,
      type: '수동'
    };
    
    //===================================================================
    // 3. 이벤트 리스너 등록
    //===================================================================
    // 메뉴 추가 버튼 이벤트 리스너
    addMenuBtn.addEventListener('click', function() {
      addMenuRow();
    });
    
    // 전체 점검 버튼 이벤트 리스너
    checkSystemBtn.addEventListener('click', function() {
      checkAllSystems();
    });
    
    // 공통 인증 모듈로 페이지 초기화
    initPage(() => {
      // 인증 확인 후 시스템 목록 가져오기
      fetchSystems();
      // 최근 점검 결과 가져오기
      fetchRecentInspections();
    });
    
    //===================================================================
    // 4. 시스템 관리 기능 (추가/수정/삭제)
    //===================================================================
    // 메뉴 행 추가 함수
    function addMenuRow(menuName = '', menuPath = '') {
      const menuItem = document.createElement('div');
      menuItem.className = 'menu-item row mb-2';
      menuItem.innerHTML = `
        <div class="col-md-5 ps-0">
          <input type="text" class="form-control menu-name" placeholder="메뉴명" value="${menuName}" required>
        </div>
        <div class="col-md-6 ps-0">
          <input type="text" class="form-control menu-path" placeholder="URL 경로 (예: /dashboard)" value="${menuPath}" required>
        </div>
        <div class="col-md-1 ps-0">
          <button type="button" class="btn btn-danger btn-sm delete-menu mt-1 mb-0"><i class="material-symbols-rounded">remove</i></button>
        </div>
      `;
      
      // 삭제 버튼 이벤트 추가
      const deleteBtn = menuItem.querySelector('.delete-menu');
      deleteBtn.addEventListener('click', function() {
        menuItem.remove();
      });
      
      menuContainer.appendChild(menuItem);
    }
    
    // 모달 닫기
    function closeSystemModal() {
      systemModal.style.display = 'none';
      systemForm.reset();
      
      // 메뉴 컨테이너 초기화
      menuContainer.innerHTML = '';
      addMenuRow(); // 기본 메뉴 행 하나 추가
    }
    
    // 모달 열기 이벤트
    addSystemBtn.addEventListener('click', function() {
      systemModalTitle.textContent = '시스템 추가';
      systemId.value = '';
      
      // 메뉴 컨테이너 초기화
      menuContainer.innerHTML = '';
      addMenuRow(); // 기본 메뉴 행 하나 추가
      
      systemModal.style.display = 'block';
    });
    
    // 모달 닫기 이벤트
    closeModal.addEventListener('click', closeSystemModal);
    cancelSystemBtn.addEventListener('click', closeSystemModal);
    window.addEventListener('click', function(event) {
      if (event.target === systemModal) {
        closeSystemModal();
      }
    });
    
    // 시스템 목록 조회
    async function fetchSystems() {
      try {
        loadingSystem.style.display = 'block';
        emptySystem.style.display = 'none';
        systemList.innerHTML = '';
        
        const response = await fetch('/api/systems');
        
        if (!response.ok) {
          throw new Error('시스템 목록을 가져오는 중 오류가 발생했습니다.');
        }
        
        const systems = await response.json();
        
        loadingSystem.style.display = 'none';
        
        if (systems.length === 0) {
          emptySystem.style.display = 'block';
          showMoreBtn.style.display = 'none';
          return;
        }
        
        renderSystems(systems);
      } catch (error) {
        console.error('Error:', error);
        loadingSystem.style.display = 'none';
        emptySystem.textContent = '시스템 목록을 불러오는 중 오류가 발생했습니다.';
        emptySystem.style.display = 'block';
      }
    }
    
    // 시스템 목록 렌더링
    function renderSystems(systems) {
      systemList.innerHTML = '';
      
      systems.forEach((system, index) => {
        const li = document.createElement('li');
        li.className = 'list-group-item border-0 d-flex p-4 mb-2 ' + (index > 0 ? 'mt-3 ' : '') + 'bg-gray-100 border-radius-lg';
        
        if (index >= 5) {
          li.classList.add('hidden-item');
        }
        
        // 메뉴 목록 HTML 생성
        let menusHTML = '';
        if (system.menus && system.menus.length > 0) {
          menusHTML = '<ul class="mb-0 ps-3">';
          system.menus.forEach(menu => {
            menusHTML += `<li><small>${menu.name}: ${system.url}${menu.path}</small></li>`;
          });
          menusHTML += '</ul>';
        } else {
          menusHTML = '<span class="text-muted">등록된 메뉴 없음</span>';
        }
        
        li.innerHTML = `
          <div class="d-flex flex-column">
            <h6 class="mb-3 text-sm">${system.kor_name}</h6>
            <span class="mb-2 text-xs">시스템 영문명: <span class="text-dark font-weight-bold ms-sm-2">${system.eng_name}</span></span>
            <span class="mb-2 text-xs">URL: <a href="${system.url}" target="_blank" class="text-dark ms-sm-2 font-weight-bold">${system.url}</a></span>
            <span class="mb-2 text-xs">점검대상 메뉴 수: <span class="text-dark ms-sm-2 font-weight-bold">${system.menus.length}개</span></span>
          </div>
          <div class="ms-auto text-end">
            <a class="btn btn-link text-danger text-gradient px-3 mb-0" href="javascript:;" data-id="${system.id}" onclick="deleteSystem('${system.id}')"><i class="material-symbols-rounded text-sm me-2">delete</i>삭제</a>
            <a class="btn btn-link text-dark px-3 mb-0" href="javascript:;" data-id="${system.id}" onclick="editSystem('${system.id}')"><i class="material-symbols-rounded text-sm me-2">edit</i>수정</a>
            <a class="btn btn-link text-dark px-3 mb-0" href="javascript:;" data-id="${system.id}" onclick="inspectSystem('${system.id}', '${system.kor_name}')"><i class="material-symbols-rounded text-sm me-2">check</i>점검</a>
          </div>
        `;
        
        systemList.appendChild(li);
      });
      
      // 더보기 버튼 표시 여부 설정
      if (systems.length > 5) {
        showMoreBtn.style.display = 'block';
      } else {
        showMoreBtn.style.display = 'none';
      }
    }
    
    //===================================================================
    // 5. 수동 점검 기능
    //===================================================================
    // 수동 점검 초기화
    function initManualInspection(systemId, systemName) {
      // 현재 점검 정보 초기화
      currentInspection = {
        systemId: systemId,
        systemName: systemName,
        menus: [],
        checkedMenus: new Set(),
        currentUrl: '',
        type: '수동',
        results: []
      };
      
      // 완료 버튼 초기화
      completeInspectionBtn.disabled = true;
      completeInspectionBtn.textContent = '점검 완료 (0 / 0)';
      
      manualInspectionModal.style.display = 'block';
      document.getElementById('manual-inspection-title').textContent = `${systemName} 수동 점검`;
      
      // 시스템 정보 로드
      fetch(`/api/systems/${systemId}`)
        .then(response => response.json())
        .then(system => {
          if (system && system.menus && system.menus.length > 0) {
            currentInspection.menus = system.menus;
            renderMenuList(system.menus, system.url);
          } else {
            manualMenuList.innerHTML = '<div class="text-center p-3">메뉴가 없습니다.</div>';
          }
        })
        .catch(error => {
          console.error('시스템 정보 로드 실패:', error);
          Swal.fire({
            title: '오류',
            text: '시스템 정보를 로드하는데 실패했습니다.'
          });
        });
    }
    
    // 완료 버튼 상태 업데이트
    function updateCompleteButtonState() {
      const allMenusChecked = currentInspection.checkedMenus.size === currentInspection.menus.length;
      completeInspectionBtn.disabled = !allMenusChecked;
      
      if (allMenusChecked) {
        completeInspectionBtn.textContent = '점검 완료 (전체 확인됨)';
      } else {
        const progress = currentInspection.checkedMenus.size + ' / ' + currentInspection.menus.length;
        completeInspectionBtn.textContent = `점검 완료 (${progress})`;
      }
    }
    
    // 메뉴 목록 렌더링
    function renderMenuList(menus, baseUrl) {
      // 메뉴 목록 초기화
      manualMenuList.innerHTML = '';
      
      // 체크된 메뉴 목록 초기화
      currentInspection.checkedMenus.clear();
      
      // 점검 결과 초기화
      currentInspection.results = [];
      
      // 완료 버튼 상태 업데이트
      updateCompleteButtonState();
      
      menus.forEach((menu, index) => {
        const menuItem = document.createElement('li');
        menuItem.className = 'list-group-item menu-item d-flex justify-content-between align-items-center py-2 px-3 mb-1';
        menuItem.dataset.index = index;
        menuItem.dataset.url = baseUrl + menu.path;
        menuItem.dataset.name = menu.name;
        
        const menuInfo = document.createElement('div');
        menuInfo.className = 'd-flex flex-column';
        
        const menuName = document.createElement('span');
        menuName.className = 'text-sm fw-bold';
        menuName.textContent = menu.name;
        
        const menuPath = document.createElement('span');
        menuPath.className = 'text-xs text-muted';
        menuPath.textContent = menu.path;
        
        menuInfo.appendChild(menuName);
        menuInfo.appendChild(menuPath);
        
        const badgeContainer = document.createElement('div');
        badgeContainer.className = 'd-flex align-items-center';
        
        // 상태 배지
        const badge = document.createElement('span');
        badge.className = 'badge bg-secondary ms-auto';
        badge.innerHTML = '<i class="material-symbols-rounded text-xs">check</i>';
        
        // 결과 버튼 그룹
        const resultBtnGroup = document.createElement('div');
        resultBtnGroup.className = 'btn-group ms-2 result-options';
        resultBtnGroup.style.display = 'none';
        
        // 정상 버튼
        const successBtn = document.createElement('button');
        successBtn.type = 'button';
        successBtn.className = 'btn btn-sm btn-success mb-0';
        successBtn.innerHTML = '<i class="material-symbols-rounded text-xs">check</i>';
        successBtn.title = '정상';
        successBtn.onclick = function(e) {
          e.stopPropagation();
          setMenuResult(menuItem, index, 200);
        };
        
        // 오류 버튼
        const errorBtn = document.createElement('button');
        errorBtn.type = 'button';
        errorBtn.className = 'btn btn-sm btn-danger mb-0';
        errorBtn.innerHTML = '<i class="material-symbols-rounded text-xs">close</i>';
        errorBtn.title = '오류';
        errorBtn.onclick = function(e) {
          e.stopPropagation();
          setMenuResult(menuItem, index, 500);
        };
        
        resultBtnGroup.appendChild(successBtn);
        resultBtnGroup.appendChild(errorBtn);
        
        // 새 탭 아이콘 추가
        const newTabIcon = document.createElement('button');
        newTabIcon.className = 'btn btn-sm btn-link p-0 ms-2';
        newTabIcon.innerHTML = '<i class="material-symbols-rounded text-xs">open_in_new</i>';
        newTabIcon.title = '새 탭에서 열기';
        newTabIcon.onclick = function(e) {
          e.stopPropagation(); // 부모 클릭 이벤트 전파 방지
          
          // 새 탭에서 URL 열기
          window.open(menuItem.dataset.url, '_blank');
          
          // 헤더 정보 가져오기
          fetchHeaderInfo(menuItem.dataset.url, menuItem, index);
          
          // 결과 버튼 표시
          resultBtnGroup.style.display = 'flex';
        };
        
        badgeContainer.appendChild(badge);
        badgeContainer.appendChild(resultBtnGroup);
        badgeContainer.appendChild(newTabIcon);
        
        menuItem.appendChild(menuInfo);
        menuItem.appendChild(badgeContainer);
        
        menuItem.addEventListener('click', function() {
          // 클릭된 메뉴 강조
          document.querySelectorAll('#manual-menu-list li').forEach(item => {
            item.classList.remove('active');
          });
          menuItem.classList.add('active');
          
          // 새 창에서 URL 열기
          window.open(menuItem.dataset.url, '_blank');
          
          // 헤더 정보 가져오기
          fetchHeaderInfo(menuItem.dataset.url, menuItem, index);
          
          // 결과 버튼 표시
          resultBtnGroup.style.display = 'flex';
        });
        
        manualMenuList.appendChild(menuItem);
      });
    }
    
    // 헤더 정보 가져오기 함수
    async function fetchHeaderInfo(url, menuItem, index) {
      try {
        // 서버를 통해 헤더 정보 가져오기
        const response = await fetch('/api/proxy-header', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ url: url })
        });
        
        if (!response.ok) {
          throw new Error('헤더 정보를 가져오는데 실패했습니다.');
        }
        
        const headerData = await response.json();
        
        // 헤더 정보가 객체가 아니거나 비어있으면 빈 객체로 초기화
        const headers = headerData.headers && typeof headerData.headers === 'object' ? headerData.headers : {};
        
        // 메뉴 아이템에 헤더 정보 저장 - 자동 검사와 동일한 형식으로 저장
        menuItem.dataset.headers = JSON.stringify(headers);
        menuItem.dataset.responseTime = headerData.responseTime || 0;
        menuItem.dataset.statusCode = headerData.status_code || 200;
        
        console.log(`[${menuItem.dataset.name}] 헤더 정보 가져옴:`, headerData);
      } catch (error) {
        console.error('헤더 정보 가져오기 실패:', error);
        // 헤더 정보를 가져오지 못한 경우 빈 객체로 설정
        menuItem.dataset.headers = '{}';
        menuItem.dataset.responseTime = '0';
      }
    }
    
    // 메뉴 검사 결과 설정 함수
    function setMenuResult(menuItem, index, statusCode) {
      const badge = menuItem.querySelector('.badge');
      const resultOptions = menuItem.querySelector('.result-options');
      
      // 상태에 따라 배지 스타일 변경
      if (statusCode >= 200 && statusCode < 400) {
        badge.className = 'badge bg-success ms-auto';
        badge.innerHTML = '<i class="material-symbols-rounded text-xs">check</i>';
        menuItem.classList.add('checked-menu');
      } else {
        badge.className = 'badge bg-danger ms-auto';
        badge.innerHTML = '<i class="material-symbols-rounded text-xs">error</i>';
        menuItem.classList.add('checked-menu');
      }
      
      // 메뉴에 결과 상태코드 저장
      menuItem.dataset.statusCode = statusCode;
      
      // 결과 옵션 숨기기
      resultOptions.style.display = 'none';
      
      // 확인한 메뉴 목록에 추가
      currentInspection.checkedMenus.add(index);
      
      // 메뉴의 점검 결과 데이터 추가
      if (!currentInspection.results) {
        currentInspection.results = [];
      }
      
      // 헤더 정보 파싱 및 변환
      let headers = {};
      try {
        headers = JSON.parse(menuItem.dataset.headers || '{}');
        // 헤더 값이 문자열이 아니면 문자열로 변환
        for (const key in headers) {
          if (headers.hasOwnProperty(key) && typeof headers[key] !== 'string') {
            headers[key] = String(headers[key]);
          }
        }
      } catch (e) {
        console.error('헤더 정보 파싱 오류:', e);
        headers = {};
      }
      
      const responseTime = parseFloat(menuItem.dataset.responseTime || '0');
      const statusText = HTTP_STATUS_TEXT[statusCode] || "오류";
      
      currentInspection.results[index] = {
        menu_name: menuItem.dataset.name,
        path: currentInspection.menus[index].path,
        status_code: statusCode,
        status_text: statusText,
        response_time: responseTime,
        headers: headers
      };
      
      // 완료 버튼 상태 업데이트
      updateCompleteButtonState();
    }
    
    // 점검 완료 및 결과 저장
    function completeInspection() {
      Swal.fire({
        title: '점검 완료',
        text: '모든 메뉴를 확인했습니다. 점검 결과를 저장하시겠습니까?',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: '저장',
        cancelButtonText: '취소'
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire({
            title: '저장 중...',
            text: '점검 결과를 저장하고 있습니다.',
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
              
              // 수동 점검 결과 데이터 준비
              const menuResults = [];
              document.querySelectorAll('#manual-menu-list li.checked-menu').forEach(item => {
                const index = parseInt(item.dataset.index);
                const statusCode = parseInt(item.dataset.statusCode) || 200;
                const menu = currentInspection.menus[index];
                
                // 헤더 정보 처리 - 자동 검사와 동일한 형식으로 변환
                let headers = {};
                try {
                  headers = JSON.parse(item.dataset.headers || '{}');
                  // 헤더 값이 문자열이 아니면 문자열로 변환
                  for (const key in headers) {
                    if (headers.hasOwnProperty(key) && typeof headers[key] !== 'string') {
                      headers[key] = String(headers[key]);
                    }
                  }
                } catch (e) {
                  console.error('헤더 정보 파싱 오류:', e);
                  headers = {};
                }
                
                const responseTime = parseFloat(item.dataset.responseTime || '0');
                const statusText = statusCode >= 200 && statusCode < 400 
                  ? "정상" 
                  : HTTP_STATUS_TEXT[statusCode] || "오류";
                
                menuResults.push({
                  menu_name: menu.name,
                  path: menu.path,
                  status_code: statusCode,
                  status_text: statusText,
                  response_time: responseTime,
                  headers: headers
                });
              });
              
              // 점검 결과 저장 API 호출
              fetch(`/api/systems/${currentInspection.systemId}/inspect`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  inspection_type: currentInspection.type,
                  inspected_by: currentUser.userid,
                  inspection_results: menuResults
                })
              })
              .then(response => {
                if (!response.ok) {
                  throw new Error('API 호출 실패');
                }
                return response.json();
              })
              .then(data => {
                manualInspectionModal.style.display = 'none';
                
                // 현재 점검 정보 초기화
                currentInspection = {
                  systemId: null,
                  systemName: null,
                  menus: [],
                  checkedMenus: new Set(),
                  currentUrl: '',
                  type: '수동',
                  results: []
                };
                
                Swal.fire({
                  title: '저장 완료',
                  text: '점검 결과가 성공적으로 저장되었습니다.',
                  confirmButtonColor: '#3085d6',
                  confirmButtonText: '확인'
                });
                
                // 시스템 목록 새로고침
                fetchSystems();
                // 최근 점검 결과 새로고침
                fetchRecentInspections();
              })
              .catch(error => {
                console.error('점검 결과 저장 실패:', error);
                Swal.fire({
                  title: '오류',
                  text: '점검 결과 저장에 실패했습니다.',
                  confirmButtonColor: '#3085d6',
                  confirmButtonText: '확인'
                });
              });
            }
          });
        }
      });
    }
    
    // 수동 점검 모달 닫기
    closeManualInspection.onclick = function() {
      if (currentInspection.checkedMenus.size > 0) {
        Swal.fire({
          title: '점검 취소',
          text: '점검을 취소하시겠습니까? 진행한 내용은 저장되지 않습니다.',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: '취소하기',
          cancelButtonText: '계속 점검'
        }).then((result) => {
          if (result.isConfirmed) {
            manualInspectionModal.style.display = 'none';
            
            // 현재 점검 정보 초기화
            currentInspection = {
              systemId: null,
              systemName: null,
              menus: [],
              checkedMenus: new Set(),
              currentUrl: '',
              type: '수동',
              results: []
            };
          }
        });
      } else {
        manualInspectionModal.style.display = 'none';
        
        // 현재 점검 정보 초기화
        currentInspection = {
          systemId: null,
          systemName: null,
          menus: [],
          checkedMenus: new Set(),
          currentUrl: '',
          type: '수동',
          results: []
        };
      }
    };
    
    // 점검 완료 버튼 이벤트
    completeInspectionBtn.addEventListener('click', completeInspection);
    
    //===================================================================
    // 6. 점검 공통 기능 (점검 방식 선택)
    //===================================================================
    // 시스템 점검
    function inspectSystem(systemId, systemName) {
      Swal.fire({
        title: '점검 방식 선택',
        text: '점검 방식을 선택해주세요.',
        showDenyButton: true,
        confirmButtonColor: '#3085d6',
        denyButtonColor: '#555',
        cancelButtonColor: '#d33',
        confirmButtonText: '자동',
        denyButtonText: '수동',
        showCancelButton: true,
        cancelButtonText: '취소'
      }).then((result) => {
        if (result.isConfirmed) {
          // 자동 점검
          doInspection(systemId, systemName, '자동');
        } else if (result.isDenied) {
          // 수동 점검
          initManualInspection(systemId, systemName);
        }
      });
    }
    
    //===================================================================
    // 7. 자동 점검 기능
    //===================================================================
    // 자동 점검 실행 함수
    async function doInspection(systemId, systemName, type) {
      try {
        // 로딩 표시
        Swal.fire({
          title: `${systemName} 점검 중...`,
          text: '점검이 완료될 때까지 기다려주세요...',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });
    
        // 점검 API 호출
        const response = await fetch(`/api/systems/${systemId}/inspect`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            inspection_type: type,
            inspected_by: currentUser.userid
          })
        });
        
        if (!response.ok) {
          throw new Error('시스템 점검 중 오류가 발생했습니다.');
        }
        
        const result = await response.json();
        
        // 점검 결과 요약
        let successCount = 0;
        let failCount = 0;
        let totalTime = 0;
        
        if (result.inspection_results) {
          result.inspection_results.forEach(menu => {
            if (menu.status_code >= 200 && menu.status_code < 400) {
              successCount++;
            } else {
              failCount++;
            }
            totalTime += menu.response_time || 0;
          });
        }
        
        // 점검 결과 표시
        Swal.fire({
          title: '점검 완료',
          html: `
            <div class="text-start">
              <p><strong>시스템:</strong> ${result.system_kor_name || systemName}</p>
              <p><strong>점검 유형:</strong> ${type}</p>
              <p><strong>점검자:</strong> ${currentUser.name || '시스템'}</p>
              <p><strong>총 메뉴:</strong> ${result.inspection_results?.length || 0}개</p>
              <p><strong>성공:</strong> ${successCount}개</p>
              <p><strong>실패:</strong> ${failCount}개</p>
              <p><strong>총 소요 시간:</strong> ${(totalTime / 1000).toFixed(2)}초</p>
            </div>
          `,
          confirmButtonColor: '#3085d6',
          confirmButtonText: '확인'
        });
        
        // 최근 점검 결과 새로고침
        fetchRecentInspections();
      } catch (error) {
        console.error('Error:', error);
        Swal.fire({
          title: '오류',
          text: '시스템 점검 중 오류가 발생했습니다.',
          confirmButtonColor: '#3085d6'
        });
      }
    }
    
    //===================================================================
    // 8. 전체 시스템 점검 기능
    //===================================================================
    // 전체 시스템 점검 함수
    async function checkAllSystems() {
      try {
        // 확인 메시지 표시
        const result = await Swal.fire({
          title: '전체 점검',
          text: '모든 시스템을 점검하시겠습니까?',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: '점검',
          cancelButtonText: '취소'
        });
        
        if (!result.isConfirmed) {
          return;
        }
        
        // 로딩 표시
        Swal.fire({
          title: '전체 점검 중...',
          text: '모든 시스템을 점검하는 중입니다. 잠시만 기다려주세요...',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });
        
        // 통합 API를 사용하여 전체 시스템 점검 수행
        const response = await fetch('/api/systems/inspect-all', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            inspected_by: currentUser.userid
          })
        });
        
        if (!response.ok) {
          throw new Error('전체 점검 중 오류가 발생했습니다.');
        }
        
        const inspections = await response.json();
        
        // 결과 요약
        let successCount = 0;
        let failCount = 0;
        
        // 각 시스템 결과 분석
        const systemResults = inspections.map(inspection => {
          const menuSuccessCount = inspection.inspection_results.filter(
            menu => menu.status_code >= 200 && menu.status_code < 400
          ).length;
          
          const menuFailCount = inspection.inspection_results.length - menuSuccessCount;
          
          // 전체 성공/실패 수 업데이트
          successCount += menuSuccessCount > 0 ? 1 : 0;
          failCount += menuFailCount > 0 ? 1 : 0;
          
          return {
            system: inspection.system_kor_name,
            success: menuFailCount === 0,
            menuSuccessCount,
            menuFailCount,
            totalMenus: inspection.inspection_results.length
          };
        });
        
        // 결과 요약 HTML 생성
        let resultHTML = `
          <div class="text-start">
            <p><strong>총 시스템:</strong> ${inspections.length}개</p>
            <p><strong>정상:</strong> ${successCount}개</p>
            <p><strong>오류:</strong> ${failCount}개</p>
            <hr>
            <p><strong>시스템별 결과:</strong></p>
            <ul style="text-align: left; list-style-type: none; padding-left: 0;">
        `;
        
        systemResults.forEach(result => {
          resultHTML += `
            <li style="margin-bottom: 5px;">
              <i class="material-symbols-rounded" style="font-size: 24px; color: ${result.success ? 'green' : 'red'};">
                ${result.success ? 'check_circle' : 'error'}
              </i>
              ${result.system} - ${result.success ? '정상' : '오류'} 
              (${result.menuSuccessCount}/${result.totalMenus})
            </li>
          `;
        });
        
        resultHTML += `</ul></div>`;
        
        // 결과 표시
        Swal.fire({
          title: '전체 점검 완료',
          html: resultHTML,
          confirmButtonColor: '#3085d6',
          confirmButtonText: '확인'
        });
        
        // 시스템 목록 새로고침
        fetchSystems();
        // 최근 점검 결과 새로고침
        fetchRecentInspections();
      } catch (error) {
        console.error('Error:', error);
        Swal.fire({
          title: '오류',
          text: '전체 시스템 점검 중 오류가 발생했습니다.',
          confirmButtonColor: '#3085d6'
        });
      }
    }
    
    //===================================================================
    // 9. 시스템 정보 관리 (삭제, 수정)
    //===================================================================
    // 전역 스코프에 함수 할당
    window.inspectSystem = inspectSystem;
    
    // 시스템 삭제
    window.deleteSystem = async function(id) {
      Swal.fire({
        title: '시스템 삭제',
        text: '정말로 이 시스템을 삭제하시겠습니까?',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#555',
        confirmButtonText: '삭제',
        cancelButtonText: '취소'
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            const response = await fetch(`/api/systems/${id}`, {
              method: 'DELETE'
            });
            
            if (!response.ok) {
              throw new Error('시스템 삭제 중 오류가 발생했습니다.');
            }
            
            Swal.fire({
              title: '삭제 완료',
              text: '시스템이 삭제되었습니다.',
              confirmButtonColor: '#3085d6'
            });
            
            // 목록 새로고침
            fetchSystems();
          } catch (error) {
            console.error('Error:', error);
            Swal.fire({
              title: '오류',
              text: '시스템 삭제 중 오류가 발생했습니다.',
              confirmButtonColor: '#3085d6'
            });
          }
        }
      });
    };
    
    // 시스템 수정
    window.editSystem = async function(id) {
      try {
        const response = await fetch(`/api/systems/${id}`);
        
        if (!response.ok) {
          throw new Error('시스템 정보를 가져오는 중 오류가 발생했습니다.');
        }
        
        const system = await response.json();
        
        // 폼에 데이터 채우기
        systemId.value = system.id;
        document.getElementById('eng-name').value = system.eng_name;
        document.getElementById('kor-name').value = system.kor_name;
        document.getElementById('url').value = system.url;
        
        // 메뉴 컨테이너 초기화
        menuContainer.innerHTML = '';
        
        // 메뉴 정보가 있으면 메뉴 행 추가
        if (system.menus && system.menus.length > 0) {
          system.menus.forEach(menu => {
            addMenuRow(menu.name, menu.path);
          });
        } else {
          // 메뉴가 없으면 빈 행 하나 추가
          addMenuRow();
        }
        
        // 모달 제목 변경 및 표시
        systemModalTitle.textContent = '시스템 수정';
        systemModal.style.display = 'block';
      } catch (error) {
        console.error('Error:', error);
        Swal.fire({
          title: '오류',
          text: '시스템 정보를 가져오는 중 오류가 발생했습니다.',
          confirmButtonColor: '#3085d6'
        });
      }
    };
    
    // 시스템 저장 (추가/수정)
    systemForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const id = systemId.value;
      const isUpdate = id !== '';
      
      // 폼 데이터 수집
      const engName = document.getElementById('eng-name').value;
      const korName = document.getElementById('kor-name').value;
      const url = document.getElementById('url').value;
      
      // 메뉴 데이터 수집
      const menuItems = document.querySelectorAll('.menu-item');
      const menus = [];
      
      menuItems.forEach(item => {
        const menuName = item.querySelector('.menu-name').value.trim();
        const menuPath = item.querySelector('.menu-path').value.trim();
        
        if (menuName && menuPath) {
          menus.push({
            name: menuName,
            path: menuPath
          });
        }
      });
      
      // 요청 데이터 구성
      const data = {
        eng_name: engName,
        kor_name: korName,
        url: url,
        menus: menus
      };
      
      // 생성자/수정자 정보 추가
      if (!isUpdate) {
        data.created_by = currentUser.userid;
      } else {
        data.updated_by = currentUser.userid;
      }
      
      try {
        // 저장 중 로딩 표시
        Swal.fire({
          title: '저장 중...',
          text: '시스템 정보를 저장하고 있습니다.',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });
        
        const response = await fetch(isUpdate ? `/api/systems/${id}` : '/api/systems', {
          method: isUpdate ? 'PUT' : 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
        
        if (!response.ok) {
          throw new Error(`시스템 ${isUpdate ? '수정' : '추가'} 중 오류가 발생했습니다.`);
        }
        
        // 모달 닫기
        closeSystemModal();
        
        // 성공 메시지
        Swal.fire({
          title: '저장 완료',
          text: `시스템이 성공적으로 ${isUpdate ? '수정' : '추가'}되었습니다.`,
          confirmButtonColor: '#3085d6'
        });
        
        // 목록 새로고침
        fetchSystems();
      } catch (error) {
        console.error('Error:', error);
        Swal.fire({
          title: '오류',
          text: `시스템 ${isUpdate ? '수정' : '추가'} 중 오류가 발생했습니다.`,
          confirmButtonColor: '#3085d6'
        });
      }
    });
    
    // 더보기 버튼 클릭 이벤트
    showMoreBtn.addEventListener('click', function() {
      // 숨겨진 아이템들 모두 표시
      const hiddenItems = document.querySelectorAll('#system-list li.hidden-item');
      hiddenItems.forEach(item => {
        item.classList.remove('hidden-item');
      });
      
      // 더보기 버튼 숨김
      this.style.display = 'none';
    });

    //===================================================================
    // 최근 점검 결과 조회 및 표시
    //===================================================================
    // 최근 점검 결과 조회 함수
    async function fetchRecentInspections() {
      try {
        const loadingInspections = document.getElementById('loading-inspections');
        const emptyInspections = document.getElementById('empty-inspections');
        const recentInspectionsList = document.getElementById('recent-inspections');
        
        loadingInspections.style.display = 'block';
        emptyInspections.style.display = 'none';
        
        // 기존 내용 초기화 (로딩 및 empty 메시지 제외)
        const items = recentInspectionsList.querySelectorAll('li');
        items.forEach(item => item.remove());
        
        // API 호출
        const response = await fetch('/api/inspections/recent');
        
        if (!response.ok) {
          throw new Error('최근 점검 결과를 가져오는 중 오류가 발생했습니다.');
        }
        
        const inspections = await response.json();
        
        loadingInspections.style.display = 'none';
        
        if (!inspections || inspections.length === 0) {
          emptyInspections.style.display = 'block';
          return;
        }
        
        // 점검 결과 표시
        renderRecentInspections(inspections);
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('loading-inspections').style.display = 'none';
        document.getElementById('empty-inspections').textContent = '점검 결과를 불러오는 중 오류가 발생했습니다.';
        document.getElementById('empty-inspections').style.display = 'block';
      }
    }
    
    // 최근 점검 결과 렌더링 함수
    function renderRecentInspections(inspections) {
      const recentInspectionsList = document.getElementById('recent-inspections');
      
      inspections.forEach(inspection => {
        // 날짜 포맷팅
        const createdDate = new Date(inspection.created_at);
        const dateFormatted = createdDate.toLocaleDateString('ko-KR', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        const timeFormatted = createdDate.toLocaleTimeString('ko-KR', {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
        
        // 시스템 표시 텍스트
        const systemText = inspection.systems_count > 1 
          ? `${inspection.first_system_name} 외 ${inspection.systems_count - 1}개 시스템` 
          : inspection.first_system_name;
        
        // 아이콘 및 색상 설정
        const isNormal = inspection.is_normal;
        const iconStyle = isNormal ? 'success' : 'danger';
        const icon = isNormal ? 'check_circle' : 'error';
        const statusText = isNormal ? '정상' : '오류';
        
        // 점검 유형 배지
        const typeBadge = inspection.inspection_type === '자동' 
          ? '<span class="badge bg-info ms-2">자동</span>'
          : '<span class="badge bg-warning ms-2">수동</span>';
        
        // 리스트 아이템 생성
        const li = document.createElement('li');
        li.className = 'list-group-item border-0 d-flex justify-content-between ps-0 mb-2 border-radius-lg';
        li.innerHTML = `
          <div class="d-flex align-items-center">
            <button class="btn btn-icon-only btn-rounded btn-outline-${iconStyle} mb-0 me-3 p-3 d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
              <i class="material-symbols-rounded" style="font-size: 24px;">${icon}</i>
            </button>
            <div class="d-flex flex-column">
              <h6 class="mb-1 text-dark text-sm">${systemText} ${typeBadge}</h6>
              <span class="text-xs">${dateFormatted}, ${timeFormatted}</span>
            </div>
          </div>
          <div class="d-flex align-items-center text-${iconStyle} text-gradient text-sm font-weight-bold">
            ${statusText}
          </div>
        `;
        
        // 상세 보기를 위한 클릭 이벤트 추가
        li.addEventListener('click', function() {
          showInspectionDetails(inspection);
        });
        
        recentInspectionsList.appendChild(li);
      });
    }
    
    // 점검 결과 상세 정보 표시
    function showInspectionDetails(inspection) {
      // 시스템 목록 HTML 생성
      let systemsHtml = '';
      const systems = inspection.document.inspection_systems;
      
      systems.forEach(system => {
        const normalCount = system.inspection_results.filter(
          result => result.status_code >= 200 && result.status_code < 400
        ).length;
        
        const errorCount = system.inspection_results.length - normalCount;
        const statusIcon = errorCount === 0 
          ? '<i class="material-symbols-rounded text-success">check_circle</i>' 
          : '<i class="material-symbols-rounded text-danger">error</i>';
        
        systemsHtml += `
          <div class="mb-2">
            <i class="material-symbols-rounded text-${errorCount === 0 ? 'success' : 'danger'}" style="font-size: 24px;">
              ${errorCount === 0 ? 'check_circle' : 'error'}
            </i>
            <strong>${system.system_kor_name}</strong> 
            (정상: ${normalCount}, 오류: ${errorCount})
          </div>
        `;
      });
      
      // 상세 정보 모달 표시
      Swal.fire({
        title: '점검 상세 정보',
        html: `
          <div class="text-start">
            <p><strong>점검 일시:</strong> ${new Date(inspection.created_at).toLocaleString('ko-KR')}</p>
            <p><strong>점검 유형:</strong> ${inspection.inspection_type}</p>
            <p><strong>점검 결과:</strong> ${inspection.is_normal ? '정상' : '오류'}</p>
            <p><strong>점검 시스템:</strong></p>
            <div class="mt-2">
              ${systemsHtml}
            </div>
          </div>
        `,
        confirmButtonColor: '#3085d6',
        confirmButtonText: '확인'
      });
    }
  });
</script>

<!-- 
========================================================
코드 구조 정리
========================================================

1. 요소 참조: 
   - 페이지의 DOM 요소들을 참조

2. 공통 상수 및 상태:
   - HTTP 상태 코드 설명 객체
   - 수동 점검 상태 관리 객체

3. 이벤트 리스너 등록:
   - 각종 버튼 및 이벤트 연결

4. 시스템 관리 기능:
   - 시스템 추가/수정/삭제
   - 메뉴 관리
   - 목록 조회 및 렌더링

5. 수동 점검 기능:
   - 점검 초기화
   - 메뉴 렌더링
   - 헤더 정보 조회
   - 결과 저장

6. 점검 공통 기능:
   - 점검 방식 선택 (자동/수동)

7. 자동 점검 기능:
   - API 호출
   - 결과 표시

8. 전체 시스템 점검 기능:
   - 모든 시스템 일괄 점검
   - 결과 요약

9. 시스템 정보 관리:
   - 삭제/수정 기능
   - 폼 처리
-->

{% endblock %}