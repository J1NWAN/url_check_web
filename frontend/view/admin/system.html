{% extends "common/layout/admin-layout.html" %}

{% block title %}System - URL Checker{% endblock %}

{% block breadcrumb_title %}시스템{% endblock %}

{% block page_styles %}
<style>
  .profile-header {
    background-image: url('/assets/img/bg-smart-home-1.jpg');
    background-position: center;
    background-size: cover;
  }
  
  .hidden-item {
    display: none;
  }
  
  .show-more-btn {
    width: 100%;
    margin-top: 15px;
  }
  
  .system-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
  }
  
  .system-modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 600px;
    border-radius: 8px;
  }
  
  .close-modal {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }
  
  .close-modal:hover,
  .close-modal:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
  }
  
  .form-group {
    margin-bottom: 15px;
  }
  
  /* 입력 필드 테두리 스타일 */
  .form-control {
    border: 1px solid #d2d6da !important;
    padding: 0.5rem 0.75rem !important;
    font-size: 0.875rem;
    line-height: 1.4rem;
    border-radius: 0.375rem;
  }
  
  .form-control:focus {
    border-color: #7928CA !important;
    box-shadow: 0 0 0 2px rgba(121, 40, 202, 0.25);
  }
  
  .menu-item {
    padding: 10px;
    border-radius: 0.375rem;
    background-color: #f8f9fa;
    margin-bottom: 8px !important;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-md-7 mt-4">
      <div class="card">
        <div class="card-header pb-0 px-3">
          <h6 class="mb-0 d-flex justify-content-between">
            시스템 목록
            <div class="d-flex justify-content-end">
              <a class="btn bg-gradient-dark mb-0 me-2" href="javascript:;" id="add-system-btn"><i class="material-symbols-rounded text-sm">add</i>&nbsp;&nbsp;시스템 추가</a>
              <a class="btn bg-gradient-dark mb-0" href="javascript:;" id="check-system-btn"><i class="material-symbols-rounded text-sm">check</i>&nbsp;&nbsp;전체 점검</a>
            </div>
          </h6>
        </div>
        <div class="card-body pt-4 p-3">
          <ul class="list-group" id="system-list">
            <!-- 시스템 목록이 여기에 동적으로 추가됩니다 -->
          </ul>
          <div id="loading-system" class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">로딩중...</span>
            </div>
          </div>
          <div id="empty-system" class="text-center py-3" style="display: none;">
            <p class="text-muted">등록된 시스템이 없습니다.</p>
          </div>
          <button id="show-more-btn" class="btn bg-gradient-primary show-more-btn" style="display: none;">더보기</button>
        </div>
      </div>
    </div>
    <div class="col-md-5 mt-4">
      <div class="card mb-4">
        <div class="card-header pb-0 px-3">
          <div class="row">
            <div class="col-md-6">
              <h6 class="mb-0">최근 점검 결과</h6>
            </div>
          </div>
        </div>
        <div class="card-body pt-4 p-3">
          <h6 class="text-uppercase text-body text-xs font-weight-bolder mb-3">Newest</h6>
          <ul class="list-group">
            <li class="list-group-item border-0 d-flex justify-content-between ps-0 mb-2 border-radius-lg">
              <div class="d-flex align-items-center">
                <button class="btn btn-icon-only btn-rounded btn-outline-danger mb-0 me-3 p-3 btn-sm d-flex align-items-center justify-content-center"><i class="material-symbols-rounded text-lg">expand_more</i></button>
                <div class="d-flex flex-column">
                  <h6 class="mb-1 text-dark text-sm">Netflix</h6>
                  <span class="text-xs">27 March 2020, at 12:30 PM</span>
                </div>
              </div>
              <div class="d-flex align-items-center text-danger text-gradient text-sm font-weight-bold">
                - $ 2,500
              </div>
            </li>
            <li class="list-group-item border-0 d-flex justify-content-between ps-0 mb-2 border-radius-lg">
              <div class="d-flex align-items-center">
                <button class="btn btn-icon-only btn-rounded btn-outline-success mb-0 me-3 p-3 btn-sm d-flex align-items-center justify-content-center"><i class="material-symbols-rounded text-lg">expand_less</i></button>
                <div class="d-flex flex-column">
                  <h6 class="mb-1 text-dark text-sm">Apple</h6>
                  <span class="text-xs">27 March 2020, at 04:30 AM</span>
                </div>
              </div>
              <div class="d-flex align-items-center text-success text-gradient text-sm font-weight-bold">
                + $ 2,000
              </div>
            </li>
          </ul>
          <h6 class="text-uppercase text-body text-xs font-weight-bolder my-3">Yesterday</h6>
          <ul class="list-group">
            <li class="list-group-item border-0 d-flex justify-content-between ps-0 mb-2 border-radius-lg">
              <div class="d-flex align-items-center">
                <button class="btn btn-icon-only btn-rounded btn-outline-success mb-0 me-3 p-3 btn-sm d-flex align-items-center justify-content-center"><i class="material-symbols-rounded text-lg">expand_less</i></button>
                <div class="d-flex flex-column">
                  <h6 class="mb-1 text-dark text-sm">Stripe</h6>
                  <span class="text-xs">26 March 2020, at 13:45 PM</span>
                </div>
              </div>
              <div class="d-flex align-items-center text-success text-gradient text-sm font-weight-bold">
                + $ 750
              </div>
            </li>
            <li class="list-group-item border-0 d-flex justify-content-between ps-0 mb-2 border-radius-lg">
              <div class="d-flex align-items-center">
                <button class="btn btn-icon-only btn-rounded btn-outline-success mb-0 me-3 p-3 btn-sm d-flex align-items-center justify-content-center"><i class="material-symbols-rounded text-lg">expand_less</i></button>
                <div class="d-flex flex-column">
                  <h6 class="mb-1 text-dark text-sm">HubSpot</h6>
                  <span class="text-xs">26 March 2020, at 12:30 PM</span>
                </div>
              </div>
              <div class="d-flex align-items-center text-success text-gradient text-sm font-weight-bold">
                + $ 1,000
              </div>
            </li>
            <li class="list-group-item border-0 d-flex justify-content-between ps-0 mb-2 border-radius-lg">
              <div class="d-flex align-items-center">
                <button class="btn btn-icon-only btn-rounded btn-outline-success mb-0 me-3 p-3 btn-sm d-flex align-items-center justify-content-center"><i class="material-symbols-rounded text-lg">expand_less</i></button>
                <div class="d-flex flex-column">
                  <h6 class="mb-1 text-dark text-sm">Creative Tim</h6>
                  <span class="text-xs">26 March 2020, at 08:30 AM</span>
                </div>
              </div>
              <div class="d-flex align-items-center text-success text-gradient text-sm font-weight-bold">
                + $ 2,500
              </div>
            </li>
            <li class="list-group-item border-0 d-flex justify-content-between ps-0 mb-2 border-radius-lg">
              <div class="d-flex align-items-center">
                <button class="btn btn-icon-only btn-rounded btn-outline-dark mb-0 me-3 p-3 btn-sm d-flex align-items-center justify-content-center"><i class="material-symbols-rounded text-lg">priority_high</i></button>
                <div class="d-flex flex-column">
                  <h6 class="mb-1 text-dark text-sm">Webflow</h6>
                  <span class="text-xs">26 March 2020, at 05:00 AM</span>
                </div>
              </div>
              <div class="d-flex align-items-center text-dark text-sm font-weight-bold">
                Pending
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 시스템 추가/수정 모달 -->
<div id="system-modal" class="system-modal">
  <div class="system-modal-content">
    <span class="close-modal">&times;</span>
    <h5 id="system-modal-title">시스템 추가</h5>
    <form id="system-form">
      <input type="hidden" id="system-id" name="system-id">
      <div class="form-group">
        <label for="eng-name">시스템 영문명</label>
        <input type="text" class="form-control" id="eng-name" name="eng-name" required>
      </div>
      <div class="form-group">
        <label for="kor-name">시스템 한글명</label>
        <input type="text" class="form-control" id="kor-name" name="kor-name" required>
      </div>
      <div class="form-group">
        <label for="url">시스템 URL (도메인)</label>
        <input type="url" class="form-control" id="url" name="url" required placeholder="도메인만 입력해주세요 (예: https://example.com)">
        <small class="form-text text-muted">도메인만 입력해주세요. 경로는 메뉴에서 지정합니다.</small>
      </div>
      <div class="form-group">
        <div class="d-flex justify-content-between align-items-center">
          <label class="mb-0">메뉴 목록</label>
          <button type="button" class="btn btn-sm bg-gradient-info mt-2 mb-2" id="add-menu-btn">
            <i class="material-symbols-rounded">add</i> 메뉴 추가
          </button>
        </div>
        <div id="menu-container">
          <!-- 메뉴 항목이 동적으로 추가됩니다 -->
        </div>
      </div>
      <div class="d-flex justify-content-end mt-4">
        <button type="button" class="btn btn-secondary me-2" id="cancel-system-btn">취소</button>
        <button type="submit" class="btn bg-gradient-primary" id="save-system-btn">저장</button>
      </div>
    </form>
  </div>
</div>

<!-- SweetAlert2 추가 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 요소 참조
    const systemList = document.getElementById('system-list');
    const loadingSystem = document.getElementById('loading-system');
    const emptySystem = document.getElementById('empty-system');
    const showMoreBtn = document.getElementById('show-more-btn');
    const systemModal = document.getElementById('system-modal');
    const systemForm = document.getElementById('system-form');
    const systemModalTitle = document.getElementById('system-modal-title');
    const systemId = document.getElementById('system-id');
    const addSystemBtn = document.getElementById('add-system-btn');
    const cancelSystemBtn = document.getElementById('cancel-system-btn');
    const closeModal = document.querySelector('.close-modal');
    const menuContainer = document.getElementById('menu-container');
    const addMenuBtn = document.getElementById('add-menu-btn');
    const checkSystemBtn = document.getElementById('check-system-btn');
    
    // 메뉴 추가 버튼 이벤트 리스너
    addMenuBtn.addEventListener('click', function() {
      addMenuRow();
    });
    
    // 메뉴 행 추가 함수
    function addMenuRow(menuName = '', menuPath = '') {
      const menuItem = document.createElement('div');
      menuItem.className = 'menu-item row mb-2';
      menuItem.innerHTML = `
        <div class="col-md-5 ps-0">
          <input type="text" class="form-control menu-name" placeholder="메뉴명" value="${menuName}" required>
        </div>
        <div class="col-md-6 ps-0">
          <input type="text" class="form-control menu-path" placeholder="URL 경로 (예: /dashboard)" value="${menuPath}" required>
        </div>
        <div class="col-md-1 ps-0">
          <button type="button" class="btn btn-danger btn-sm delete-menu mt-1 mb-0"><i class="material-symbols-rounded">remove</i></button>
        </div>
      `;
      
      // 삭제 버튼 이벤트 추가
      const deleteBtn = menuItem.querySelector('.delete-menu');
      deleteBtn.addEventListener('click', function() {
        menuItem.remove();
      });
      
      menuContainer.appendChild(menuItem);
    }
    
    // 모달 닫기
    function closeSystemModal() {
      systemModal.style.display = 'none';
      systemForm.reset();
      
      // 메뉴 컨테이너 초기화
      menuContainer.innerHTML = '';
      addMenuRow(); // 기본 메뉴 행 하나 추가
    }
    
    // 모달 열기 이벤트
    addSystemBtn.addEventListener('click', function() {
      systemModalTitle.textContent = '시스템 추가';
      systemId.value = '';
      
      // 메뉴 컨테이너 초기화
      menuContainer.innerHTML = '';
      addMenuRow(); // 기본 메뉴 행 하나 추가
      
      systemModal.style.display = 'block';
    });
    
    // 모달 닫기 이벤트
    closeModal.addEventListener('click', closeSystemModal);
    cancelSystemBtn.addEventListener('click', closeSystemModal);
    window.addEventListener('click', function(event) {
      if (event.target === systemModal) {
        closeSystemModal();
      }
    });
    
    // 시스템 목록 조회
    async function fetchSystems() {
      try {
        loadingSystem.style.display = 'block';
        emptySystem.style.display = 'none';
        systemList.innerHTML = '';
        
        const response = await fetch('/api/systems');
        
        if (!response.ok) {
          throw new Error('시스템 목록을 가져오는 중 오류가 발생했습니다.');
        }
        
        const systems = await response.json();
        
        loadingSystem.style.display = 'none';
        
        if (systems.length === 0) {
          emptySystem.style.display = 'block';
          showMoreBtn.style.display = 'none';
          return;
        }
        
        renderSystems(systems);
      } catch (error) {
        console.error('Error:', error);
        loadingSystem.style.display = 'none';
        emptySystem.textContent = '시스템 목록을 불러오는 중 오류가 발생했습니다.';
        emptySystem.style.display = 'block';
      }
    }
    
    // 시스템 목록 렌더링
    function renderSystems(systems) {
      systemList.innerHTML = '';
      
      systems.forEach((system, index) => {
        const li = document.createElement('li');
        li.className = 'list-group-item border-0 d-flex p-4 mb-2 ' + (index > 0 ? 'mt-3 ' : '') + 'bg-gray-100 border-radius-lg';
        
        if (index >= 5) {
          li.classList.add('hidden-item');
        }
        
        // 메뉴 목록 HTML 생성
        let menusHTML = '';
        if (system.menus && system.menus.length > 0) {
          menusHTML = '<ul class="mb-0 ps-3">';
          system.menus.forEach(menu => {
            menusHTML += `<li><small>${menu.name}: ${system.url}${menu.path}</small></li>`;
          });
          menusHTML += '</ul>';
        } else {
          menusHTML = '<span class="text-muted">등록된 메뉴 없음</span>';
        }
        
        li.innerHTML = `
          <div class="d-flex flex-column">
            <h6 class="mb-3 text-sm">${system.kor_name}</h6>
            <span class="mb-2 text-xs">시스템 영문명: <span class="text-dark font-weight-bold ms-sm-2">${system.eng_name}</span></span>
            <span class="mb-2 text-xs">URL: <a href="${system.url}" target="_blank" class="text-dark ms-sm-2 font-weight-bold">${system.url}</a></span>
            <span class="mb-2 text-xs">점검대상 메뉴 수: <span class="text-dark ms-sm-2 font-weight-bold">${system.menus.length}개</span></span>
          </div>
          <div class="ms-auto text-end">
            <a class="btn btn-link text-danger text-gradient px-3 mb-0" href="javascript:;" data-id="${system.id}" onclick="deleteSystem('${system.id}')"><i class="material-symbols-rounded text-sm me-2">delete</i>삭제</a>
            <a class="btn btn-link text-dark px-3 mb-0" href="javascript:;" data-id="${system.id}" onclick="editSystem('${system.id}')"><i class="material-symbols-rounded text-sm me-2">edit</i>수정</a>
            <a class="btn btn-link text-dark px-3 mb-0" href="javascript:;" data-id="${system.id}" onclick="inspectSystem('${system.id}', '${system.kor_name}')"><i class="material-symbols-rounded text-sm me-2">check</i>점검</a>
          </div>
        `;
        
        systemList.appendChild(li);
      });
      
      // 더보기 버튼 표시 여부 설정
      if (systems.length > 5) {
        showMoreBtn.style.display = 'block';
      } else {
        showMoreBtn.style.display = 'none';
      }
    }
    
    // 시스템 점검 함수
    window.inspectSystem = function(id, name) {
      Swal.fire({
        title: `${name} 점검`,
        text: '점검 방식을 선택해주세요',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: '자동',
        cancelButtonText: '수동',
        reverseButtons: true
      }).then((result) => {
        if (result.isConfirmed) {
          // 자동 점검 선택 시
          doInspection(id, name, "자동");
        } else if (result.dismiss === Swal.DismissReason.cancel) {
          // 수동 점검 선택 시
          doInspection(id, name, "수동");
        }
      });
    };
    
    // 전체 시스템 점검 버튼 이벤트
    checkSystemBtn.addEventListener('click', function() {
      Swal.fire({
        title: '전체 시스템 점검',
        text: '모든 시스템을 점검하시겠습니까?',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: '예',
        cancelButtonText: '아니오'
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            const response = await fetch('/api/systems');
            if (!response.ok) {
              throw new Error('시스템 목록을 가져오는 중 오류가 발생했습니다.');
            }
            
            const systems = await response.json();
            if (systems.length === 0) {
              Swal.fire('알림', '점검할 시스템이 없습니다.', 'info');
              return;
            }
            
            // 로딩 알림
            Swal.fire({
              title: '전체 시스템 점검 중...',
              html: '점검이 완료될 때까지 기다려주세요...',
              allowOutsideClick: false,
              didOpen: () => {
                Swal.showLoading();
              }
            });
            
            // 각 시스템 순차적으로 점검
            let completedCount = 0;
            for (const system of systems) {
              try {
                await fetch(`/api/systems/${system.id}/inspect?inspection_type=자동`, {
                  method: 'POST'
                });
                completedCount++;
              } catch (error) {
                console.error(`${system.kor_name} 점검 실패:`, error);
              }
            }
            
            Swal.fire(
              '점검 완료',
              `총 ${systems.length}개 중 ${completedCount}개 시스템 점검 완료`,
              'success'
            );
            
          } catch (error) {
            console.error('Error:', error);
            Swal.fire('오류', '전체 시스템 점검 중 오류가 발생했습니다.', 'error');
          }
        }
      });
    });
    
    // 실제 점검 수행 함수
    async function doInspection(id, name, type) {
      try {
        // 로딩 표시
        Swal.fire({
          title: `${name} 점검 중...`,
          html: '점검이 완료될 때까지 기다려주세요...',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });
        
        // 점검 API 호출
        const response = await fetch(`/api/systems/${id}/inspect?inspection_type=${type}`, {
          method: 'POST'
        });
        
        if (!response.ok) {
          throw new Error('시스템 점검 중 오류가 발생했습니다.');
        }
        
        const result = await response.json();
        
        // 점검 결과 요약
        let successCount = 0;
        let failCount = 0;
        let totalTime = 0;
        
        result.menu_results.forEach(menu => {
          if (menu.status_code >= 200 && menu.status_code < 400) {
            successCount++;
          } else {
            failCount++;
          }
          totalTime += menu.response_time;
        });
        
        // 점검 결과 표시
        Swal.fire({
          title: '점검 완료',
          html: `
            <div class="text-start">
              <p><strong>시스템:</strong> ${result.system_kor_name}</p>
              <p><strong>점검 유형:</strong> ${type}</p>
              <p><strong>총 메뉴:</strong> ${result.menu_results.length}개</p>
              <p><strong>성공:</strong> ${successCount}개</p>
              <p><strong>실패:</strong> ${failCount}개</p>
              <p><strong>총 소요 시간:</strong> ${(totalTime / 1000).toFixed(2)}초</p>
            </div>
          `,
          icon: failCount > 0 ? 'warning' : 'success',
          confirmButtonText: '확인',
          showCancelButton: true,
          cancelButtonText: '상세 결과 보기'
        }).then((result) => {
          if (result.dismiss === Swal.DismissReason.cancel) {
            // 상세 결과 보기 로직 추가 (향후 구현)
            // TODO: 상세 결과 페이지로 이동
            console.log('상세 결과 보기');
          }
        });
        
      } catch (error) {
        console.error('Error:', error);
        Swal.fire('오류', '시스템 점검 중 오류가 발생했습니다.', 'error');
      }
    }
    
    // 시스템 삭제
    window.deleteSystem = async function(id) {
      if (!confirm('정말로 이 시스템을 삭제하시겠습니까?')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/systems/${id}`, {
          method: 'DELETE'
        });
        
        if (!response.ok) {
          throw new Error('시스템 삭제 중 오류가 발생했습니다.');
        }
        
        // 목록 새로고침
        fetchSystems();
      } catch (error) {
        console.error('Error:', error);
        alert('시스템 삭제 중 오류가 발생했습니다.');
      }
    };
    
    // 시스템 수정
    window.editSystem = async function(id) {
      try {
        const response = await fetch(`/api/systems/${id}`);
        
        if (!response.ok) {
          throw new Error('시스템 정보를 가져오는 중 오류가 발생했습니다.');
        }
        
        const system = await response.json();
        
        // 폼에 데이터 채우기
        systemId.value = system.id;
        document.getElementById('eng-name').value = system.eng_name;
        document.getElementById('kor-name').value = system.kor_name;
        document.getElementById('url').value = system.url;
        
        // 메뉴 컨테이너 초기화
        menuContainer.innerHTML = '';
        
        // 메뉴 정보가 있으면 메뉴 행 추가
        if (system.menus && system.menus.length > 0) {
          system.menus.forEach(menu => {
            addMenuRow(menu.name, menu.path);
          });
        } else {
          // 메뉴가 없으면 빈 행 하나 추가
          addMenuRow();
        }
        
        // 모달 제목 변경 및 표시
        systemModalTitle.textContent = '시스템 수정';
        systemModal.style.display = 'block';
      } catch (error) {
        console.error('Error:', error);
        alert('시스템 정보를 가져오는 중 오류가 발생했습니다.');
      }
    };
    
    // 시스템 저장 (추가/수정)
    systemForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const id = systemId.value;
      const isUpdate = id !== '';
      
      // 폼 데이터 수집
      const engName = document.getElementById('eng-name').value;
      const korName = document.getElementById('kor-name').value;
      const url = document.getElementById('url').value;
      
      // 메뉴 데이터 수집
      const menuItems = document.querySelectorAll('.menu-item');
      const menus = [];
      
      menuItems.forEach(item => {
        const menuName = item.querySelector('.menu-name').value.trim();
        const menuPath = item.querySelector('.menu-path').value.trim();
        
        if (menuName && menuPath) {
          menus.push({
            name: menuName,
            path: menuPath
          });
        }
      });
      
      // 요청 데이터 구성
      const data = {
        eng_name: engName,
        kor_name: korName,
        url: url,
        menus: menus
      };
      
      // 추가 시 생성자 정보 추가
      if (!isUpdate) {
        data.created_by = "system"; // 실제 사용자 ID로 대체해야 함
      } else {
        data.updated_by = "system"; // 실제 사용자 ID로 대체해야 함
      }
      
      try {
        const response = await fetch(isUpdate ? `/api/systems/${id}` : '/api/systems', {
          method: isUpdate ? 'PUT' : 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
        
        if (!response.ok) {
          throw new Error(`시스템 ${isUpdate ? '수정' : '추가'} 중 오류가 발생했습니다.`);
        }
        
        // 모달 닫기
        closeSystemModal();
        
        // 목록 새로고침
        fetchSystems();
      } catch (error) {
        console.error('Error:', error);
        alert(`시스템 ${isUpdate ? '수정' : '추가'} 중 오류가 발생했습니다.`);
      }
    });
    
    // 더보기 버튼 클릭 이벤트
    showMoreBtn.addEventListener('click', function() {
      // 숨겨진 아이템들 모두 표시
      const hiddenItems = document.querySelectorAll('#system-list li.hidden-item');
      hiddenItems.forEach(item => {
        item.classList.remove('hidden-item');
      });
      
      // 더보기 버튼 숨김
      this.style.display = 'none';
    });
    
    // 초기 데이터 로드
    fetchSystems();
  });
</script>
{% endblock %}