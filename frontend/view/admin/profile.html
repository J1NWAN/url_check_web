{% extends "common/layout/admin-layout.html" %}

{% block title %}Profile - URL Checker{% endblock %}

{% block breadcrumb_title %}Profile{% endblock %}

{% block page_styles %}
<style>
  .profile-header {
    background-image: url('/assets/img/bg-smart-home-1.jpg');
    background-position: center;
    background-size: cover;
  }

  /* 입력 필드 테두리 스타일 */
  .form-control {
    border: 1px solid #d2d6da !important;
    padding: 0.5rem 0.75rem !important;
    font-size: 0.875rem;
    line-height: 1.4rem;
    border-radius: 0.375rem;
  }
  
  .form-control:focus {
    border-color: #7928CA !important;
    box-shadow: 0 0 0 2px rgba(121, 40, 202, 0.25);
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-2 px-md-4">
  <div class="page-header min-height-300 border-radius-xl mt-4" style="background-image: url('https://images.unsplash.com/photo-1531512073830-ba890ca4eba2?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80');">
    <span class="mask  bg-gradient-dark  opacity-6"></span>
  </div>
  <div class="card card-body mx-2 mx-md-2 mt-n6">
    <div class="row gx-4 mb-2">
      <div class="col-auto">
        <div class="avatar avatar-xl position-relative">
          <img src="../assets/img/bruce-mars.jpg" alt="profile_image" class="w-100 border-radius-lg shadow-sm">
        </div>
      </div>
      <div class="col-auto my-auto">
        <div class="h-100">
          <h5 class="mb-1 user-name">
            Richard Davis
          </h5>
          <p class="mb-0 font-weight-normal text-sm">
            CEO / Co-Founder
          </p>
        </div>
      </div>
      <div class="col-lg-4 col-md-6 my-sm-auto ms-sm-auto me-sm-0 mx-auto mt-3">
        <div class="nav-wrapper position-relative end-0">
          <ul class="nav nav-pills nav-fill p-1" role="tablist">
            <li class="nav-item">
              <a class="nav-link mb-0 px-0 py-1 active " data-bs-toggle="tab" href="javascript:;" role="tab" aria-selected="true">
                <i class="material-symbols-rounded text-lg position-relative">person</i>
                <span class="ms-1">사용자</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link mb-0 px-0 py-1 " data-bs-toggle="tab" href="javascript:;" role="tab" aria-selected="false">
                <i class="material-symbols-rounded text-lg position-relative">email</i>
                <span class="ms-1">메일</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link mb-0 px-0 py-1 " data-bs-toggle="tab" href="javascript:;" role="tab" aria-selected="false">
                <i class="material-symbols-rounded text-lg position-relative">settings</i>
                <span class="ms-1">설정</span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="row">
        <div class="col-12 col-xl-4">
          <div class="card card-plain h-100">
            <div class="card-header pb-0 p-3">
              <h6 class="mb-0">Platform Settings</h6>
            </div>
            <div class="card-body p-3">
              <h6 class="text-uppercase text-body text-xs font-weight-bolder">권한</h6>
              <ul class="list-group">
                <li class="list-group-item border-0 px-0">
                  <div class="form-check form-switch ps-0">
                    <input class="form-check-input ms-auto" type="checkbox" id="flexSwitchCheckDefault" checked>
                    <label class="form-check-label text-body ms-3 text-truncate w-80 mb-0" for="flexSwitchCheckDefault">Email me when someone follows me</label>
                  </div>
                </li>
                <li class="list-group-item border-0 px-0">
                  <div class="form-check form-switch ps-0">
                    <input class="form-check-input ms-auto" type="checkbox" id="flexSwitchCheckDefault1">
                    <label class="form-check-label text-body ms-3 text-truncate w-80 mb-0" for="flexSwitchCheckDefault1">Email me when someone answers on my post</label>
                  </div>
                </li>
                <li class="list-group-item border-0 px-0">
                  <div class="form-check form-switch ps-0">
                    <input class="form-check-input ms-auto" type="checkbox" id="flexSwitchCheckDefault2" checked>
                    <label class="form-check-label text-body ms-3 text-truncate w-80 mb-0" for="flexSwitchCheckDefault2">Email me when someone mentions me</label>
                  </div>
                </li>
              </ul>
              <h6 class="text-uppercase text-body text-xs font-weight-bolder mt-4">Application</h6>
              <ul class="list-group">
                <li class="list-group-item border-0 px-0">
                  <div class="form-check form-switch ps-0">
                    <input class="form-check-input ms-auto" type="checkbox" id="flexSwitchCheckDefault3">
                    <label class="form-check-label text-body ms-3 text-truncate w-80 mb-0" for="flexSwitchCheckDefault3">New launches and projects</label>
                  </div>
                </li>
                <li class="list-group-item border-0 px-0">
                  <div class="form-check form-switch ps-0">
                    <input class="form-check-input ms-auto" type="checkbox" id="flexSwitchCheckDefault4" checked>
                    <label class="form-check-label text-body ms-3 text-truncate w-80 mb-0" for="flexSwitchCheckDefault4">Monthly product updates</label>
                  </div>
                </li>
                <li class="list-group-item border-0 px-0 pb-0">
                  <div class="form-check form-switch ps-0">
                    <input class="form-check-input ms-auto" type="checkbox" id="flexSwitchCheckDefault5">
                    <label class="form-check-label text-body ms-3 text-truncate w-80 mb-0" for="flexSwitchCheckDefault5">Subscribe to newsletter</label>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="col-12 col-xl-4">
          <div class="card card-plain h-100">
            <div class="card-header pb-0 p-3">
              <div class="row">
                <div class="col-md-8 d-flex align-items-center">
                  <h6 class="mb-0">프로필 정보</h6>
                </div>
                <div class="col-md-4 text-end">
                  <a href="javascript:;" id="editProfileBtn">
                    <i class="fas fa-user-edit text-secondary text-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="Edit Profile"></i>
                  </a>
                </div>
              </div>
            </div>
            <div class="card-body p-3">
              <p class="text-sm">
                <span class="user-bio">자기소개</span>
              </p>
              <hr class="horizontal gray-light my-4">
              <ul class="list-group">
                <li class="list-group-item border-0 ps-0 pt-0 text-sm"><strong class="text-dark">이름:</strong> &nbsp; <span class="user-name"></span></li>
                <li class="list-group-item border-0 ps-0 text-sm"><strong class="text-dark">아이디:</strong> &nbsp; <span class="user-id"></span></li>
                <li class="list-group-item border-0 ps-0 text-sm"><strong class="text-dark">휴대폰번호:</strong> &nbsp; <span class="user-phone"></span></li>
                <li class="list-group-item border-0 ps-0 text-sm"><strong class="text-dark">이메일주소:</strong> &nbsp; <span class="user-email"></span></li>
              </ul>
            </div>
          </div>
        </div>
        <div class="col-12 col-xl-4">
          <div class="card card-plain h-100">
            <div class="card-header pb-0 p-3">
              <h6 class="mb-0">Conversations</h6>
            </div>
            <div class="card-body p-3">
              <ul class="list-group">
                <li class="list-group-item border-0 d-flex align-items-center px-0 mb-2 pt-0">
                  <div class="avatar me-3">
                    <img src="../assets/img/kal-visuals-square.jpg" alt="kal" class="border-radius-lg shadow">
                  </div>
                  <div class="d-flex align-items-start flex-column justify-content-center">
                    <h6 class="mb-0 text-sm">Sophie B.</h6>
                    <p class="mb-0 text-xs">Hi! I need more information..</p>
                  </div>
                  <a class="btn btn-link pe-3 ps-0 mb-0 ms-auto w-25 w-md-auto" href="javascript:;">Reply</a>
                </li>
                <li class="list-group-item border-0 d-flex align-items-center px-0 mb-2">
                  <div class="avatar me-3">
                    <img src="../assets/img/marie.jpg" alt="kal" class="border-radius-lg shadow">
                  </div>
                  <div class="d-flex align-items-start flex-column justify-content-center">
                    <h6 class="mb-0 text-sm">Anne Marie</h6>
                    <p class="mb-0 text-xs">Awesome work, can you..</p>
                  </div>
                  <a class="btn btn-link pe-3 ps-0 mb-0 ms-auto w-25 w-md-auto" href="javascript:;">Reply</a>
                </li>
                <li class="list-group-item border-0 d-flex align-items-center px-0 mb-2">
                  <div class="avatar me-3">
                    <img src="../assets/img/ivana-square.jpg" alt="kal" class="border-radius-lg shadow">
                  </div>
                  <div class="d-flex align-items-start flex-column justify-content-center">
                    <h6 class="mb-0 text-sm">Ivanna</h6>
                    <p class="mb-0 text-xs">About files I can..</p>
                  </div>
                  <a class="btn btn-link pe-3 ps-0 mb-0 ms-auto w-25 w-md-auto" href="javascript:;">Reply</a>
                </li>
                <li class="list-group-item border-0 d-flex align-items-center px-0 mb-2">
                  <div class="avatar me-3">
                    <img src="../assets/img/team-4.jpg" alt="kal" class="border-radius-lg shadow">
                  </div>
                  <div class="d-flex align-items-start flex-column justify-content-center">
                    <h6 class="mb-0 text-sm">Peterson</h6>
                    <p class="mb-0 text-xs">Have a great afternoon..</p>
                  </div>
                  <a class="btn btn-link pe-3 ps-0 mb-0 ms-auto w-25 w-md-auto" href="javascript:;">Reply</a>
                </li>
                <li class="list-group-item border-0 d-flex align-items-center px-0">
                  <div class="avatar me-3">
                    <img src="../assets/img/team-3.jpg" alt="kal" class="border-radius-lg shadow">
                  </div>
                  <div class="d-flex align-items-start flex-column justify-content-center">
                    <h6 class="mb-0 text-sm">Nick Daniel</h6>
                    <p class="mb-0 text-xs">Hi! I need more information..</p>
                  </div>
                  <a class="btn btn-link pe-3 ps-0 mb-0 ms-auto w-25 w-md-auto" href="javascript:;">Reply</a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 프로필 수정 모달 -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editProfileModalLabel">프로필 수정</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="profileEditForm">
          <div class="mb-3">
            <label for="userid" class="form-label">아이디</label>
            <input type="text" class="form-control" id="userid" disabled>
          </div>
          <div class="mb-3">
            <label for="name" class="form-label">이름</label>
            <input type="text" class="form-control" id="name" disabled>
          </div>
          <div class="mb-3">
            <label for="newPassword" class="form-label">새 비밀번호</label>
            <input type="password" class="form-control" id="newPassword" placeholder="새 비밀번호를 입력하세요" required>
            <div class="form-text">영어, 숫자, 특수문자 조합, 8~20자</div>
          </div>
          <div class="mb-3">
            <label for="phone" class="form-label">휴대폰번호</label>
            <input type="text" class="form-control" id="phone" placeholder="휴대폰번호를 입력하세요">
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">이메일주소</label>
            <input type="email" class="form-control" id="email" placeholder="이메일을 입력하세요" required>
          </div>
          <div class="mb-3">
            <label for="bio" class="form-label">소개</label>
            <textarea class="form-control" id="bio" rows="3" placeholder="자기소개를 입력하세요"></textarea>
          </div>
          <div class="alert alert-danger" id="profileEditError" style="display: none;"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
        <button type="button" class="btn btn-primary" id="saveProfileBtn">저장</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block page_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 사이드바 활성화
    const profileLink = document.querySelector('a[data-nav-id="profile"]');
    if (profileLink) {
      profileLink.classList.add('active', 'bg-gradient-dark', 'text-white');
      profileLink.classList.remove('text-dark');
    }
    
    // 저장된 토큰 가져오기
    const token = localStorage.getItem('access_token') || sessionStorage.getItem('access_token');
    
    if (!token) {
      window.location.href = '/auth/signin';
      return;
    }
    
    // 사용자 정보 가져오기
    fetchUserProfile();
    
    // 프로필 수정 버튼 클릭 이벤트
    document.getElementById('editProfileBtn').addEventListener('click', function() {
      const modal = new bootstrap.Modal(document.getElementById('editProfileModal'));
      modal.show();
    });
    
    // 프로필 저장 버튼 클릭 이벤트
    document.getElementById('saveProfileBtn').addEventListener('click', updateProfile);
    
    // 사용자 프로필 정보 가져오기
    async function fetchUserProfile() {
      try {
        // API 호출로 사용자 정보 가져오기
        const response = await fetch('/api/auth/me', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('프로필 정보를 가져오는데 실패했습니다.');
        }
        
        const userData = await response.json();
        console.log('API에서 가져온 사용자 정보:', userData);
        
        // 화면에 사용자 정보 표시
        document.getElementById('userid').value = userData.userid || '';
        document.getElementById('name').value = userData.name || '';
        document.getElementById('email').value = userData.email || '';
        document.getElementById('phone').value = userData.phone || '';
        document.getElementById('bio').value = userData.bio || '';

        // getElementsByClassName은 컬렉션을 반환하므로 각 요소에 접근해야 합니다
        const userIdElements = document.getElementsByClassName('user-id');
        for (let i = 0; i < userIdElements.length; i++) {
          userIdElements[i].textContent = userData.userid || '';
        }
        
        const userNameElements = document.getElementsByClassName('user-name');
        for (let i = 0; i < userNameElements.length; i++) {
          userNameElements[i].textContent = userData.name || '';
        }
        
        const userEmailElements = document.getElementsByClassName('user-email');
        for (let i = 0; i < userEmailElements.length; i++) {
          userEmailElements[i].textContent = userData.email || '';
        }
        
        const userPhoneElements = document.getElementsByClassName('user-phone');
        for (let i = 0; i < userPhoneElements.length; i++) {
          userPhoneElements[i].textContent = userData.phone || '';
        }
      } catch (error) {
        console.error('프로필 정보 가져오기 오류:', error);
        
        // API 호출 실패 시 토큰에서 정보를 파싱하여 표시 (대체 방안)
        try {
          const tokenPayload = parseJwt(token);
          
          if (tokenPayload) {
            document.getElementById('userid').value = tokenPayload.userid || '';
            document.getElementById('name').value = tokenPayload.name || '';
            
            const userNameElements = document.getElementsByClassName('user-name');
            for (let i = 0; i < userNameElements.length; i++) {
              userNameElements[i].textContent = tokenPayload.name || '사용자';
            }
            
            const userIdElements = document.getElementsByClassName('user-id');
            for (let i = 0; i < userIdElements.length; i++) {
              userIdElements[i].textContent = tokenPayload.userid || '';
            }
          }
        } catch (e) {
          console.error('토큰 파싱 오류:', e);
        }
      }
    }
    
    // 프로필 업데이트
    async function updateProfile() {
      const saveProfileBtn = document.getElementById('saveProfileBtn');
      const profileEditError = document.getElementById('profileEditError');
      
      // 폼 데이터 가져오기
      const newPassword = document.getElementById('newPassword').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const bio = document.getElementById('bio').value.trim();
      
      // 필수 입력값 검증
      if (!email) {
        profileEditError.textContent = '이메일은 필수 입력값입니다.';
        profileEditError.style.display = 'block';
        return;
      }
      
      // 이메일 형식 검증
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        profileEditError.textContent = '유효한 이메일 형식이 아닙니다.';
        profileEditError.style.display = 'block';
        return;
      }
      
      // 휴대폰번호 형식 검증 (입력된 경우)
      if (phone) {
        const phoneRegex = /^01[016789]-?\d{3,4}-?\d{4}$/;
        if (!phoneRegex.test(phone)) {
          profileEditError.textContent = '유효한 휴대폰번호 형식이 아닙니다.';
          profileEditError.style.display = 'block';
          return;
        }
      }
      
      // 비밀번호 검증 (입력된 경우)
      if (newPassword) {
        // 비밀번호 길이 검증
        if (newPassword.length < 8 || newPassword.length > 20) {
          profileEditError.textContent = '비밀번호는 8~20자 사이여야 합니다.';
          profileEditError.style.display = 'block';
          return;
        }
      }
      
      try {
        saveProfileBtn.disabled = true;
        profileEditError.style.display = 'none';
        
        // 업데이트할 데이터 준비
        const updateData = {
          email: email,
          phone: phone,
          bio: bio
        };
        
        // 비밀번호가 입력된 경우만 포함
        if (newPassword) {
          updateData.new_password = newPassword;
        }
        
        // API 호출로 프로필 업데이트
        const response = await fetch('/api/profile/update', {
          method: 'PUT',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}` 
          },
          body: JSON.stringify(updateData)
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.detail || '프로필 업데이트 중 오류가 발생했습니다.');
        }
        
        // 성공 시 처리
        alert('프로필이 업데이트되었습니다.');
        
        // 모달 닫기
        const modal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
        modal.hide();
        
        // 업데이트된 정보 다시 불러오기
        fetchUserProfile();
      } catch (error) {
        profileEditError.textContent = error.message || '프로필 업데이트 중 오류가 발생했습니다.';
        profileEditError.style.display = 'block';
      } finally {
        saveProfileBtn.disabled = false;
      }
    }
    
    // JWT 토큰에서 페이로드 파싱
    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        
        return JSON.parse(jsonPayload);
      } catch (e) {
        console.error('토큰 파싱 오류:', e);
        return null;
      }
    }
  });
</script>
{% endblock %}