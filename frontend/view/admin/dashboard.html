{% extends "common/layout/admin-layout.html" %}

{% block title %}대시보드 - URL Checker{% endblock %}

{% block breadcrumb_title %}대시보드{% endblock %}

{% block content %}
  <div class="row">
    <div class="ms-3">
      <h3 class="mb-0 h4 font-weight-bolder">대시보드</h3>
      <p class="mb-4">
        최근 점검 결과를 간략하게 확인할 수 있습니다.
      </p>
    </div>
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card">
        <div class="card-header p-2 ps-3">
          <div class="d-flex justify-content-between">
            <div>
              <p class="text-sm mb-0 text-capitalize">금일 점검 횟수</p>
              <h4 class="mb-0" id="today-inspection-count">-</h4>
            </div>
            <div class="icon icon-md icon-shape bg-gradient-dark shadow-dark shadow text-center border-radius-lg">
              <i class="material-symbols-rounded opacity-10">weekend</i>
            </div>
          </div>
        </div>
        <hr class="dark horizontal my-0">
        <div class="card-footer p-2 ps-3">
          <p class="mb-0 text-sm"><span class="text-success font-weight-bolder">+55% </span>than last week</p>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card">
        <div class="card-header p-2 ps-3">
          <div class="d-flex justify-content-between">
            <div>
              <p class="text-sm mb-0 text-capitalize">금일 정상 시스템</p>
              <h4 class="mb-0" id="today-success-count">-</h4>
            </div>
            <div class="icon icon-md icon-shape bg-gradient-dark shadow-dark shadow text-center border-radius-lg">
              <i class="material-symbols-rounded opacity-10">person</i>
            </div>
          </div>
        </div>
        <hr class="dark horizontal my-0">
        <div class="card-footer p-2 ps-3">
          <p class="mb-0 text-sm"><span class="text-success font-weight-bolder">+3% </span>than last month</p>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card">
        <div class="card-header p-2 ps-3">
          <div class="d-flex justify-content-between">
            <div>
              <p class="text-sm mb-0 text-capitalize">금일 오류 시스템</p>
              <h4 class="mb-0" id="today-error-count">-</h4>
            </div>
            <div class="icon icon-md icon-shape bg-gradient-dark shadow-dark shadow text-center border-radius-lg">
              <i class="material-symbols-rounded opacity-10">leaderboard</i>
            </div>
          </div>
        </div>
        <hr class="dark horizontal my-0">
        <div class="card-footer p-2 ps-3">
          <p class="mb-0 text-sm"><span class="text-danger font-weight-bolder">-2% </span>than yesterday</p>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-sm-6">
      <div class="card">
        <div class="card-header p-2 ps-3">
          <div class="d-flex justify-content-between">
            <div>
              <p class="text-sm mb-0 text-capitalize">이번달 점검 횟수</p>
              <h4 class="mb-0" id="month-inspection-count">-</h4>
            </div>
            <div class="icon icon-md icon-shape bg-gradient-dark shadow-dark shadow text-center border-radius-lg">
              <i class="material-symbols-rounded opacity-10">weekend</i>
            </div>
          </div>
        </div>
        <hr class="dark horizontal my-0">
        <div class="card-footer p-2 ps-3">
          <p class="mb-0 text-sm"><span class="text-success font-weight-bolder">+5% </span>than yesterday</p>
        </div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-lg-4 col-md-6 mt-4 mb-4">
      <div class="card">
        <div class="card-body">
          <h6 class="mb-0 ">시스템별 최신 점검 상태</h6>
          <p class="text-sm ">각 시스템의 최신 점검 결과</p>
          <div class="pe-2">
            <div class="chart">
              <canvas id="chart-bars" class="chart-canvas" height="170"></canvas>
            </div>
          </div>
          <hr class="dark horizontal">
          <div class="d-flex ">
            <i class="material-symbols-rounded text-sm my-auto me-1">schedule</i>
            <p class="mb-0 text-sm" id="system-bar-date"> </p>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4 col-md-6 mt-4 mb-4">
      <div class="card ">
        <div class="card-body">
          <h6 class="mb-0 "> 이번주 점검 횟수 통계 </h6>
          <p class="text-sm "> (<span class="font-weight-bolder">+15%</span>) increase in today sales. </p>
          <div class="pe-2">
            <div class="chart">
              <canvas id="chart-line" class="chart-canvas" height="170"></canvas>
            </div>
          </div>
          <hr class="dark horizontal">
          <div class="d-flex ">
            <i class="material-symbols-rounded text-sm my-auto me-1">schedule</i>
            <p class="mb-0 text-sm" id="weekly-line-date-range"> </p>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4 mt-4 mb-3">
      <div class="card">
        <div class="card-body">
          <h6 class="mb-0" id="current-year-title">0000년 점검 횟수 통계</h6>
          <p class="text-sm">월별 점검 건수 현황</p>
          <div class="pe-2">
            <div class="chart">
              <canvas id="chart-line-tasks" class="chart-canvas" height="170"></canvas>
            </div>
          </div>
          <hr class="dark horizontal">
          <div class="d-flex ">
            <i class="material-symbols-rounded text-sm my-auto me-1">schedule</i>
            <p class="mb-0 text-sm" id="yearly-date-range"> </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-lg-8 col-md-6 mb-md-0 mb-4">
      <div class="card">
        <div class="card-header pb-0">
          <div class="row">
            <div class="col-lg-6 col-7">
              <h6>Projects</h6>
              <p class="text-sm mb-0">
                <i class="fa fa-check text-info" aria-hidden="true"></i>
                <span class="font-weight-bold ms-1">30 done</span> this month
              </p>
            </div>
            <div class="col-lg-6 col-5 my-auto text-end">
              <div class="dropdown float-lg-end pe-4">
                <a class="cursor-pointer" id="dropdownTable" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fa fa-ellipsis-v text-secondary"></i>
                </a>
                <ul class="dropdown-menu px-2 py-3 ms-sm-n4 ms-n5" aria-labelledby="dropdownTable">
                  <li><a class="dropdown-item border-radius-md" href="javascript:;">Action</a></li>
                  <li><a class="dropdown-item border-radius-md" href="javascript:;">Another action</a></li>
                  <li><a class="dropdown-item border-radius-md" href="javascript:;">Something else here</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="card-body px-0 pb-2">
          <div class="table-responsive">
            <table class="table align-items-center mb-0">
              <thead>
                <tr>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Companies</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Members</th>
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Budget</th>
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Completion</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    <div class="d-flex px-2 py-1">
                      <div>
                        <img src="../assets/img/small-logos/logo-xd.svg" class="avatar avatar-sm me-3" alt="xd">
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="mb-0 text-sm">Material XD Version</h6>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="avatar-group mt-2">
                      <a href="javascript:;" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Ryan Tompson">
                        <img src="../assets/img/team-1.jpg" alt="team1">
                      </a>
                      <a href="javascript:;" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Romina Hadid">
                        <img src="../assets/img/team-2.jpg" alt="team2">
                      </a>
                      <a href="javascript:;" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Alexander Smith">
                        <img src="../assets/img/team-3.jpg" alt="team3">
                      </a>
                      <a href="javascript:;" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Jessica Doe">
                        <img src="../assets/img/team-4.jpg" alt="team4">
                      </a>
                    </div>
                  </td>
                  <td class="align-middle text-center text-sm">
                    <span class="text-xs font-weight-bold"> $14,000 </span>
                  </td>
                  <td class="align-middle">
                    <div class="progress-wrapper w-75 mx-auto">
                      <div class="progress-info">
                        <div class="progress-percentage">
                          <span class="text-xs font-weight-bold">60%</span>
                        </div>
                      </div>
                      <div class="progress">
                        <div class="progress-bar bg-gradient-info w-60" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>
                    <div class="d-flex px-2 py-1">
                      <div>
                        <img src="../assets/img/small-logos/logo-atlassian.svg" class="avatar avatar-sm me-3" alt="atlassian">
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="mb-0 text-sm">Add Progress Track</h6>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="avatar-group mt-2">
                      <a href="javascript:;" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Romina Hadid">
                        <img src="../assets/img/team-2.jpg" alt="team5">
                      </a>
                      <a href="javascript:;" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Jessica Doe">
                        <img src="../assets/img/team-4.jpg" alt="team6">
                      </a>
                    </div>
                  </td>
                  <td class="align-middle text-center text-sm">
                    <span class="text-xs font-weight-bold"> $3,000 </span>
                  </td>
                  <td class="align-middle">
                    <div class="progress-wrapper w-75 mx-auto">
                      <div class="progress-info">
                        <div class="progress-percentage">
                          <span class="text-xs font-weight-bold">10%</span>
                        </div>
                      </div>
                      <div class="progress">
                        <div class="progress-bar bg-gradient-info w-10" role="progressbar" aria-valuenow="10" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>
                    <div class="d-flex px-2 py-1">
                      <div>
                        <img src="../assets/img/small-logos/logo-slack.svg" class="avatar avatar-sm me-3" alt="team7">
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="mb-0 text-sm">Fix Platform Errors</h6>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="avatar-group mt-2">
                      <a href="javascript:;" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Romina Hadid">
                        <img src="../assets/img/team-3.jpg" alt="team8">
                      </a>
                      <a href="javascript:;" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Jessica Doe">
                        <img src="../assets/img/team-1.jpg" alt="team9">
                      </a>
                    </div>
                  </td>
                  <td class="align-middle text-center text-sm">
                    <span class="text-xs font-weight-bold"> Not set </span>
                  </td>
                  <td class="align-middle">
                    <div class="progress-wrapper w-75 mx-auto">
                      <div class="progress-info">
                        <div class="progress-percentage">
                          <span class="text-xs font-weight-bold">100%</span>
                        </div>
                      </div>
                      <div class="progress">
                        <div class="progress-bar bg-gradient-success w-100" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>
                    <div class="d-flex px-2 py-1">
                      <div>
                        <img src="../assets/img/small-logos/logo-spotify.svg" class="avatar avatar-sm me-3" alt="spotify">
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="mb-0 text-sm">Launch our Mobile App</h6>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="avatar-group mt-2">
                      <a href="javascript:;" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Ryan Tompson">
                        <img src="../assets/img/team-4.jpg" alt="user1">
                      </a>
                      <a href="javascript:;" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Romina Hadid">
                        <img src="../assets/img/team-3.jpg" alt="user2">
                      </a>
                      <a href="javascript:;" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Alexander Smith">
                        <img src="../assets/img/team-4.jpg" alt="user3">
                      </a>
                      <a href="javascript:;" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Jessica Doe">
                        <img src="../assets/img/team-1.jpg" alt="user4">
                      </a>
                    </div>
                  </td>
                  <td class="align-middle text-center text-sm">
                    <span class="text-xs font-weight-bold"> $20,500 </span>
                  </td>
                  <td class="align-middle">
                    <div class="progress-wrapper w-75 mx-auto">
                      <div class="progress-info">
                        <div class="progress-percentage">
                          <span class="text-xs font-weight-bold">100%</span>
                        </div>
                      </div>
                      <div class="progress">
                        <div class="progress-bar bg-gradient-success w-100" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>
                    <div class="d-flex px-2 py-1">
                      <div>
                        <img src="../assets/img/small-logos/logo-jira.svg" class="avatar avatar-sm me-3" alt="jira">
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="mb-0 text-sm">Add the New Pricing Page</h6>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="avatar-group mt-2">
                      <a href="javascript:;" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Ryan Tompson">
                        <img src="../assets/img/team-4.jpg" alt="user5">
                      </a>
                    </div>
                  </td>
                  <td class="align-middle text-center text-sm">
                    <span class="text-xs font-weight-bold"> $500 </span>
                  </td>
                  <td class="align-middle">
                    <div class="progress-wrapper w-75 mx-auto">
                      <div class="progress-info">
                        <div class="progress-percentage">
                          <span class="text-xs font-weight-bold">25%</span>
                        </div>
                      </div>
                      <div class="progress">
                        <div class="progress-bar bg-gradient-info w-25" role="progressbar" aria-valuenow="25" aria-valuemin="0" aria-valuemax="25"></div>
                      </div>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>
                    <div class="d-flex px-2 py-1">
                      <div>
                        <img src="../assets/img/small-logos/logo-invision.svg" class="avatar avatar-sm me-3" alt="invision">
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="mb-0 text-sm">Redesign New Online Shop</h6>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="avatar-group mt-2">
                      <a href="javascript:;" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Ryan Tompson">
                        <img src="../assets/img/team-1.jpg" alt="user6">
                      </a>
                      <a href="javascript:;" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Jessica Doe">
                        <img src="../assets/img/team-4.jpg" alt="user7">
                      </a>
                    </div>
                  </td>
                  <td class="align-middle text-center text-sm">
                    <span class="text-xs font-weight-bold"> $2,000 </span>
                  </td>
                  <td class="align-middle">
                    <div class="progress-wrapper w-75 mx-auto">
                      <div class="progress-info">
                        <div class="progress-percentage">
                          <span class="text-xs font-weight-bold">40%</span>
                        </div>
                      </div>
                      <div class="progress">
                        <div class="progress-bar bg-gradient-info w-40" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="40"></div>
                      </div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4 col-md-6">
      <div class="card h-100">
        <div class="card-header pb-0">
          <h6>이번주 점검 대상자</h6>
        </div>
        <div class="card-body p-3">
          <div class="timeline timeline-one-side">
            <div class="timeline-block mb-3">
              <span class="timeline-step">
                <i class="material-symbols-rounded text-success text-gradient">person</i>
              </span>
              <div class="timeline-content">
                <h6 class="text-dark text-sm font-weight-bold mb-0">김철수</h6>
                <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">오전</p>
              </div>
            </div>
            <div class="timeline-block mb-3">
              <span class="timeline-step">
                <i class="material-symbols-rounded text-danger text-gradient">person</i>
              </span>
              <div class="timeline-content">
                <h6 class="text-dark text-sm font-weight-bold mb-0">이영희</h6>
                <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">점심</p>
              </div>
            </div>
            <div class="timeline-block mb-3">
              <span class="timeline-step">
                <i class="material-symbols-rounded text-info text-gradient">person</i>
              </span>
              <div class="timeline-content">
                <h6 class="text-dark text-sm font-weight-bold mb-0">박영수</h6>
                <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">오후</p>
              </div>
            </div>
          </div>
        </div>
        <div class="card-header pb-0">
          <h6>다음주 점검 대상자</h6>
        </div>
        <div class="card-body p-3">
          <div class="timeline timeline-one-side">
            <div class="timeline-block mb-3">
              <span class="timeline-step">
                <i class="material-symbols-rounded text-success text-gradient">person</i>
              </span>
              <div class="timeline-content">
                <h6 class="text-dark text-sm font-weight-bold mb-0">최영호</h6>
                <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">오전</p>
              </div>
            </div>
            <div class="timeline-block mb-3">
              <span class="timeline-step">
                <i class="material-symbols-rounded text-danger text-gradient">person</i>
              </span>
              <div class="timeline-content">
                <h6 class="text-dark text-sm font-weight-bold mb-0">최영호</h6>
                <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">점심</p>
              </div>
            </div>
            <div class="timeline-block mb-3">
              <span class="timeline-step">
                <i class="material-symbols-rounded text-info text-gradient">person</i>
              </span>
              <div class="timeline-content">
                <h6 class="text-dark text-sm font-weight-bold mb-0">최영호</h6>
                <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">오후</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
  // 공통 인증 모듈 초기화
  initPage(() => {
    // 대시보드 통계 데이터 가져오기
    fetchDashboardStats();
    
    // 현재 연도 표시
    updateYearTitle();
  });
  
  // 현재 연도 표시 함수
  function updateYearTitle() {
    // 현재 연도를 표시하지 않고, API에서 받은 데이터로 표시하도록 수정
    // API 데이터가 로드되기 전 기본값만 설정
    const currentYear = new Date().getFullYear();
    const yearTitleElement = document.getElementById('current-year-title');
    if (yearTitleElement) {
      yearTitleElement.textContent = currentYear + '년 점검 횟수 통계';
    }
    
    // 연간 날짜 범위 기본값 업데이트
    const yearlyDateRange = document.getElementById('yearly-date-range');
    if (yearlyDateRange) {
      yearlyDateRange.textContent = currentYear + '-01 ~ ' + currentYear + '-12';
    }
    
    // 주간 날짜 범위 업데이트
    updateWeeklyDateRange();
  }
  
  // 주간 날짜 범위 계산 및 표시 함수
  function updateWeeklyDateRange() {
    // 현재 날짜 기준으로 이번 주의 일요일과 토요일 구하기
    const now = new Date();
    const currentDay = now.getDay(); // 0: 일요일, 1: 월요일, ..., 6: 토요일
    
    // 이번 주 일요일 계산 (현재 날짜 - 현재 요일)
    const sunday = new Date(now);
    sunday.setDate(now.getDate() - currentDay);
    
    // 이번 주 토요일 계산 (일요일 + 6일)
    const saturday = new Date(sunday);
    saturday.setDate(sunday.getDate() + 6);
    
    // 날짜 포맷 함수
    const formatDate = (date) => {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    };
    
    // 날짜 범위 텍스트 생성
    const dateRangeText = `${formatDate(sunday)} ~ ${formatDate(saturday)}`;
    
    // 주간 막대 차트 날짜 범위 업데이트
    const weeklyBarDateRange = document.getElementById('system-bar-date');
    if (weeklyBarDateRange) {
      weeklyBarDateRange.textContent = dateRangeText;
    }
    
    // 주간 라인 차트 날짜 범위 업데이트
    const weeklyLineDateRange = document.getElementById('weekly-line-date-range');
    if (weeklyLineDateRange) {
      weeklyLineDateRange.textContent = dateRangeText;
    }
  }
  
  // 대시보드 통계 데이터 가져오는 함수
  async function fetchDashboardStats() {
    try {
      const response = await fetch('/api/dashboard/stats');
      
      if (!response.ok) {
        throw new Error('통계 데이터를 가져오는 중 오류가 발생했습니다.');
      }
      
      const data = await response.json();
      
      // 데이터를 화면에 표시
      document.getElementById('today-inspection-count').textContent = data.today_inspection_count;
      document.getElementById('today-success-count').textContent = data.today_success_system_count;
      document.getElementById('today-error-count').textContent = data.today_error_system_count;
      document.getElementById('month-inspection-count').textContent = data.month_inspection_count;
      
      // 시스템별 최신 통계 데이터가 있는 경우 차트 업데이트
      if (data.system_stats) {
        updateSystemStatusChart(data.system_stats);
      }
      
      // 주간 데이터가 있는 경우 차트 업데이트
      if (data.weekly_inspection_stats) {
        updateWeeklyCharts(data.weekly_inspection_stats);
      }
      
      // 연간 데이터가 있는 경우 차트 업데이트
      if (data.yearly_inspection_stats) {
        updateYearlyChart(data.yearly_inspection_stats);
      }
    } catch (error) {
      console.error('대시보드 통계 데이터 로딩 오류:', error);
      // 오류 처리 - 필요시 사용자에게 알림
    }
  }
  
  // 주간 차트 업데이트 함수
  function updateWeeklyCharts(weeklyStats) {
    // 이번주 점검 횟수 통계 차트 업데이트 (라인 차트)
    updateWeeklyLineChart(weeklyStats);
  }
  
  // 시스템별 최신 상태 차트 업데이트
  function updateSystemStatusChart(systemStats) {
    const ctx = document.getElementById("chart-bars").getContext("2d");
    
    // 시스템 중 가장 최신 점검 일시를 찾아 표시
    const systemBarDate = document.getElementById("system-bar-date");
    if (systemBarDate && systemStats.latest_datetime && systemStats.latest_datetime.length > 0) {
      // 가장 최신 점검 일시 찾기 (가장 마지막으로 점검된 시스템의 일시)
      let latestDateTime = '';
      for (let i = 0; i < systemStats.latest_datetime.length; i++) {
        if (systemStats.latest_datetime[i] && 
            (!latestDateTime || systemStats.latest_datetime[i] > latestDateTime)) {
          latestDateTime = systemStats.latest_datetime[i];
        }
      }
      
      if (latestDateTime) {
        systemBarDate.textContent = `최신 점검 일시: ${latestDateTime}`;
      } else {
        // 점검 일시가 없는 경우 현재 시간 표시
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        systemBarDate.textContent = `현재 시간 기준: ${year}-${month}-${day} ${hours}시 ${minutes}분 ${seconds}초`;
      }
    }
    
    // 데이터의 최대값 계산 (정상 + 오류 메뉴 수 중 최대값)
    const maxMenuCount = Math.max(
      ...systemStats.success_data.map((val, idx) => val + systemStats.error_data[idx])
    );
    
    new Chart(ctx, {
      type: "bar",
      data: {
        labels: systemStats.labels,
        datasets: [
          {
            label: "정상",
            tension: 0.4,
            borderWidth: 0,
            borderRadius: 0,
            borderSkipped: false,
            backgroundColor: "rgba(76, 175, 80, 0.8)",  // 초록색
            data: systemStats.success_data,
            maxBarThickness: 25
          },
          {
            label: "오류",
            tension: 0.4,
            borderWidth: 0,
            borderRadius: 0,
            borderSkipped: false,
            backgroundColor: "rgba(244, 67, 53, 0.8)",  // 빨간색
            data: systemStats.error_data,
            maxBarThickness: 25
          }
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        barPercentage: 0.8,
        categoryPercentage: 0.8,
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              color: "#666"
            }
          },
          tooltip: {
            callbacks: {
              title: function(context) {
                return context[0].label;
              },
              label: function(context) {
                const label = context.dataset.label || '';
                const value = context.parsed.y;
                return label + ' 메뉴: ' + value + '개';
              }
            }
          }
        },
        interaction: {
          intersect: false,
          mode: 'index',
        },
        scales: {
          y: {
            stacked: true,
            grid: {
              drawBorder: false,
              display: true,
              drawOnChartArea: true,
              drawTicks: false,
              borderDash: [5, 5],
              color: 'rgba(255, 255, 255, .2)'
            },
            ticks: {
              suggestedMin: 0,
              suggestedMax: maxMenuCount > 0 ? maxMenuCount : 3, // 메뉴 합계가 최대값이 되도록
              beginAtZero: true,
              padding: 10,
              precision: 0,  // 소수점 없이 정수로만 표시
              stepSize: 1,   // 눈금 간격 1로 설정
              font: {
                size: 14,
                weight: 300,
                family: "Roboto",
                style: 'normal',
                lineHeight: 2
              },
              color: "#fff"
            }
          },
          x: {
            stacked: true,
            grid: {
              drawBorder: false,
              display: true,
              drawOnChartArea: true,
              drawTicks: false,
              borderDash: [5, 5],
              color: 'rgba(255, 255, 255, .2)'
            },
            ticks: {
              display: true,
              color: '#666',
              padding: 10,
              font: {
                size: 11,
                weight: 400,
                family: "Roboto",
                style: 'normal',
                lineHeight: 2
              }
            },
          }
        }
      }
    });
  }
  
  // 이번주 점검 횟수 통계 라인 차트 업데이트
  function updateWeeklyLineChart(weeklyStats) {
    const ctx2 = document.getElementById("chart-line").getContext("2d");
    
    // 데이터의 최대값 계산
    const maxValue = Math.max(...weeklyStats.total_data);
    
    new Chart(ctx2, {
      type: "line",
      data: {
        labels: weeklyStats.labels,
        datasets: [{
          label: "점검 횟수",
          tension: 0.3,
          borderWidth: 2,
          pointRadius: 3,
          pointBackgroundColor: "#4CAF50",
          pointBorderColor: "#fff",
          borderColor: "#4CAF50",
          backgroundColor: "transparent",
          fill: false,
          data: weeklyStats.total_data,
          maxBarThickness: 6
        }],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false,
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + context.raw + '회';
              }
            }
          }
        },
        interaction: {
          intersect: false,
          mode: 'index',
        },
        scales: {
          y: {
            grid: {
              drawBorder: false,
              display: true,
              drawOnChartArea: true,
              drawTicks: false,
              color: 'rgba(0, 0, 0, 0.1)',
              borderDash: []
            },
            ticks: {
              display: true,
              color: '#666',
              padding: 10,
              font: {
                size: 11,
                weight: 400,
                family: "Roboto",
                style: 'normal',
                lineHeight: 1.5
              },
              callback: function(value) {
                return value + '회';
              },
              precision: 0,  // 소수점 없이 정수로만 표시
              stepSize: 1    // 눈금 간격 1로 설정
            },
            suggestedMin: 0
          },
          x: {
            grid: {
              drawBorder: false,
              display: true,
              drawOnChartArea: true,
              drawTicks: false,
              color: 'rgba(0, 0, 0, 0.05)'
            },
            ticks: {
              display: true,
              color: '#666',
              padding: 10,
              font: {
                size: 11,
                weight: 400,
                family: "Roboto",
                style: 'normal',
                lineHeight: 1.5
              }
            }
          }
        }
      }
    });
  }
  
  // 연간 차트 업데이트 함수
  function updateYearlyChart(yearlyStats) {
    // 연도 타이틀 업데이트
    const yearTitleElement = document.getElementById('current-year-title');
    if (yearTitleElement) {
      yearTitleElement.textContent = yearlyStats.year + '년 점검 횟수 통계';
    }
    
    // 연간 날짜 범위 업데이트
    const yearlyDateRange = document.getElementById('yearly-date-range');
    if (yearlyDateRange) {
      yearlyDateRange.textContent = yearlyStats.year + '-01 ~ ' + yearlyStats.year + '-12';
    }
    
    // 연간 차트 업데이트
    const ctx3 = document.getElementById("chart-line-tasks").getContext("2d");
    
    new Chart(ctx3, {
      type: "line",
      data: {
        labels: yearlyStats.labels,
        datasets: [{
          label: "점검 횟수",
          tension: 0.3,
          borderWidth: 2,
          pointRadius: 3,
          pointBackgroundColor: "#4CAF50",
          pointBorderColor: "#fff",
          borderColor: "#4CAF50",
          backgroundColor: "transparent",
          fill: false,
          data: yearlyStats.data,
          maxBarThickness: 6
        }],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false,
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + context.raw + '회';
              }
            }
          }
        },
        interaction: {
          intersect: false,
          mode: 'index',
        },
        scales: {
          y: {
            grid: {
              drawBorder: false,
              display: true,
              drawOnChartArea: true,
              drawTicks: false,
              color: 'rgba(0, 0, 0, 0.1)',
              borderDash: []
            },
            ticks: {
              display: true,
              color: '#666',
              padding: 10,
              font: {
                size: 11,
                weight: 400,
                family: "Roboto",
                style: 'normal',
                lineHeight: 1.5
              },
              callback: function(value) {
                return value + '회';
              },
              precision: 0,  // 소수점 없이 정수로만 표시
              stepSize: 1    // 눈금 간격 1로 설정
            },
            suggestedMin: 0
          },
          x: {
            grid: {
              drawBorder: false,
              display: true,
              drawOnChartArea: true,
              drawTicks: false,
              color: 'rgba(0, 0, 0, 0.05)'
            },
            ticks: {
              display: true,
              color: '#666',
              padding: 10,
              font: {
                size: 11,
                weight: 400,
                family: "Roboto",
                style: 'normal',
                lineHeight: 1.5
              }
            }
          }
        }
      }
    });
  }
  
  // 사이드바 활성화
  document.addEventListener('DOMContentLoaded', function() {
    const dashboardLink = document.querySelector('a[data-nav-id="dashboard"]');
    if (dashboardLink) {
      dashboardLink.classList.add('active', 'bg-gradient-dark', 'text-white');
      dashboardLink.classList.remove('text-dark');
    }
  });
</script>
{% endblock %}